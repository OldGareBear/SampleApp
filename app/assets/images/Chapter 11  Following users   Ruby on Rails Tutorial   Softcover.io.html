<!DOCTYPE html>
<!-- saved from url=(0071)http://www.railstutorial.org/book/following_users#cha-11_footnote-ref-8 -->
<html id="custDomain"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/6713.js" async="" type="text/javascript"></script><script async="" src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/analytics.js"></script><script type="text/javascript">window.NREUM||(NREUM={});NREUM.info={"beacon":"beacon-2.newrelic.com","errorBeacon":"bam.nr-data.net","licenseKey":"1310fd97f1","applicationID":"4014257","transactionName":"IVZWR0tbWF4BFxhWVw1SSxxaQUdGCwhoRl0DXQ==","queueTime":11,"applicationTime":95,"ttGuid":"","agentToken":null,"agent":"js-agent.newrelic.com/nr-411.min.js"}</script>
<script type="text/javascript">window.NREUM||(NREUM={}),__nr_require=function(t,n,e){function r(e){if(!n[e]){var o=n[e]={exports:{}};t[e][0].call(o.exports,function(n){var o=t[e][1][n];return r(o?o:n)},o,o.exports)}return n[e].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<e.length;o++)r(e[o]);return r}({D5DuLP:[function(t,n){function e(t,n){var e=r[t];return e?e.apply(this,n):(o[t]||(o[t]=[]),void o[t].push(n))}var r={},o={};n.exports=e,e.queues=o,e.handlers=r},{}],handle:[function(t,n){n.exports=t("D5DuLP")},{}],G9z0Bl:[function(t,n){function e(){var t=l.info=NREUM.info;if(t&&t.agent&&t.licenseKey&&t.applicationID&&p&&p.body){l.proto="https"===f.split(":")[0]||t.sslForHttp?"https://":"http://",i("mark",["onload",a()]);var n=p.createElement("script");n.src=l.proto+t.agent,p.body.appendChild(n)}}function r(){"complete"===p.readyState&&o()}function o(){i("mark",["domContent",a()])}function a(){return(new Date).getTime()}var i=t("handle"),u=window,p=u.document,s="addEventListener",c="attachEvent",f=(""+location).split("?")[0],l=n.exports={offset:a(),origin:f,features:[]};p[s]?(p[s]("DOMContentLoaded",o,!1),u[s]("load",e,!1)):(p[c]("onreadystatechange",r),u[c]("onload",e)),i("mark",["firstbyte",a()])},{handle:"D5DuLP"}],loader:[function(t,n){n.exports=t("G9z0Bl")},{}]},{},["G9z0Bl"]);</script>
<script src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/1197428788.js" type="text/javascript"></script>

<title>Chapter 11: Following users
 | Ruby on Rails Tutorial | Softcover.io</title>
<meta charset="UTF-8">
<script>
  window.Config = {
    bucket: "softcover"
  }
</script>
<link href="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/reading-0013543a64ea6779764aa99d1540a27e.css" media="screen" rel="stylesheet" type="text/css">
<link href="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/print-ca85c1c74168e935ca4e2e958a3a5c2b.css" media="print" rel="stylesheet" type="text/css">
<script src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/jquery-2.0.3.min.js" type="text/javascript"></script>
<script src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/jquery.formalize.min.js" type="text/javascript"></script>
<script src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/underscore-min.js" type="text/javascript"></script>
<script src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/saved_resource" type="text/javascript"></script>
<script src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/application-ba4cccdb966196cb0931f2e621520564.js" type="text/javascript"></script>
<meta content="authenticity_token" name="csrf-param">
<meta content="l2d1hCplQwnNw9+2VR+3FIVgqg3ecIBCQsMtb2XMxPM=" name="csrf-token">
<link href="http://www.railstutorial.org/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed">
<link href="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/css" rel="stylesheet" type="text/css">
<link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
<script src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/jsapi" type="text/javascript"></script>
<script>
  // test key only
  // this identifies your website in the createToken call below
  Stripe.setPublishableKey('pk_live_Xn1p0BfxqKxkAxtEr03P7wmd');
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('require', 'linker');
  ga('linker:autoLink', ['www.railstutorial.org', 'softcover.io']);

  ga('create', 'UA-46858978-1', 'softcover.io', {'allowLinker': true});
  ga('send', 'pageview');

  ga('create', 'UA-8667566-1', 'auto', {
    'name': 'book',
    'allowLinker': true
  });

  ga('book.send', 'pageview');

</script>
<script type="text/javascript">var _sf_startpt=(new Date()).getTime()</script>


<script src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/custom_domain_js.js" type="text/javascript"></script>
<style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Hover_Arrow {position: absolute; width: 15px; height: 11px; cursor: pointer}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; color: #666666}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_Menu_Close {position: absolute; width: 31px; height: 31px; top: -15px; left: -15px}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MathJax_Display {text-align: center; margin: 1em 0em; position: relative; display: block; width: 100%}
.MathJax .merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
#MathJax_Tooltip {background-color: InfoBackground; color: InfoText; border: 1px solid black; box-shadow: 2px 2px 5px #AAAAAA; -webkit-box-shadow: 2px 2px 5px #AAAAAA; -moz-box-shadow: 2px 2px 5px #AAAAAA; -khtml-box-shadow: 2px 2px 5px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true'); padding: 3px 4px; z-index: 401; position: absolute; left: 0; top: 0; width: auto; height: auto; display: none}
.MathJax {display: inline; font-style: normal; font-weight: normal; line-height: normal; font-size: 100%; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; border: 0; padding: 0; margin: 0}
.MathJax img, .MathJax nobr, .MathJax a {border: 0; padding: 0; margin: 0; max-width: none; max-height: none; vertical-align: 0; line-height: normal; text-decoration: none}
img.MathJax_strut {border: 0 !important; padding: 0 !important; margin: 0 !important; vertical-align: 0 !important}
.MathJax span {display: inline; position: static; border: 0; padding: 0; margin: 0; vertical-align: 0; line-height: normal; text-decoration: none}
.MathJax nobr {white-space: nowrap ! important}
.MathJax img {display: inline ! important; float: none ! important}
.MathJax * {transition: none; -webkit-transition: none; -moz-transition: none; -ms-transition: none; -o-transition: none}
.MathJax_Processing {visibility: hidden; position: fixed; width: 0; height: 0; overflow: hidden}
.MathJax_Processed {display: none!important}
.MathJax_ExBox {display: block; overflow: hidden; width: 1px; height: 60ex}
.MathJax .MathJax_EmBox {display: block; overflow: hidden; width: 1px; height: 60em}
.MathJax .MathJax_HitBox {cursor: text; background: white; opacity: 0; filter: alpha(opacity=0)}
.MathJax .MathJax_HitBox * {filter: none; opacity: 1; background: transparent}
#MathJax_Tooltip * {filter: none; opacity: 1; background: transparent}
@font-face {font-family: MathJax_Main; src: url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/woff/MathJax_Main-Regular.woff') format('woff'), url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/otf/MathJax_Main-Regular.otf') format('opentype')}
@font-face {font-family: MathJax_Main; src: url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/woff/MathJax_Main-Bold.woff') format('woff'), url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/otf/MathJax_Main-Bold.otf') format('opentype'); font-weight: bold}
@font-face {font-family: MathJax_Main; src: url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/woff/MathJax_Main-Italic.woff') format('woff'), url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/otf/MathJax_Main-Italic.otf') format('opentype'); font-style: italic}
@font-face {font-family: MathJax_Math; src: url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/woff/MathJax_Math-Italic.woff') format('woff'), url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/otf/MathJax_Math-Italic.otf') format('opentype'); font-style: italic}
@font-face {font-family: MathJax_Caligraphic; src: url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/woff/MathJax_Caligraphic-Regular.woff') format('woff'), url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/otf/MathJax_Caligraphic-Regular.otf') format('opentype')}
@font-face {font-family: MathJax_Size1; src: url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/woff/MathJax_Size1-Regular.woff') format('woff'), url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/otf/MathJax_Size1-Regular.otf') format('opentype')}
@font-face {font-family: MathJax_Size2; src: url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/woff/MathJax_Size2-Regular.woff') format('woff'), url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/otf/MathJax_Size2-Regular.otf') format('opentype')}
@font-face {font-family: MathJax_Size3; src: url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/woff/MathJax_Size3-Regular.woff') format('woff'), url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/otf/MathJax_Size3-Regular.otf') format('opentype')}
@font-face {font-family: MathJax_Size4; src: url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/woff/MathJax_Size4-Regular.woff') format('woff'), url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/otf/MathJax_Size4-Regular.otf') format('opentype')}
.MathJax .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Hover_Arrow {position: absolute; width: 15px; height: 11px; cursor: pointer}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; color: #666666}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_Menu_Close {position: absolute; width: 31px; height: 31px; top: -15px; left: -15px}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Hover_Arrow {position: absolute; width: 15px; height: 11px; cursor: pointer}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; color: #666666}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_Menu_Close {position: absolute; width: 31px; height: 31px; top: -15px; left: -15px}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MathJax_Display {text-align: center; margin: 1em 0em; position: relative; display: block; width: 100%}
.MathJax .merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
#MathJax_Tooltip {background-color: InfoBackground; color: InfoText; border: 1px solid black; box-shadow: 2px 2px 5px #AAAAAA; -webkit-box-shadow: 2px 2px 5px #AAAAAA; -moz-box-shadow: 2px 2px 5px #AAAAAA; -khtml-box-shadow: 2px 2px 5px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true'); padding: 3px 4px; z-index: 401; position: absolute; left: 0; top: 0; width: auto; height: auto; display: none}
.MathJax {display: inline; font-style: normal; font-weight: normal; line-height: normal; font-size: 100%; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; border: 0; padding: 0; margin: 0}
.MathJax img, .MathJax nobr, .MathJax a {border: 0; padding: 0; margin: 0; max-width: none; max-height: none; vertical-align: 0; line-height: normal; text-decoration: none}
img.MathJax_strut {border: 0 !important; padding: 0 !important; margin: 0 !important; vertical-align: 0 !important}
.MathJax span {display: inline; position: static; border: 0; padding: 0; margin: 0; vertical-align: 0; line-height: normal; text-decoration: none}
.MathJax nobr {white-space: nowrap ! important}
.MathJax img {display: inline ! important; float: none ! important}
.MathJax * {transition: none; -webkit-transition: none; -moz-transition: none; -ms-transition: none; -o-transition: none}
.MathJax_Processing {visibility: hidden; position: fixed; width: 0; height: 0; overflow: hidden}
.MathJax_Processed {display: none!important}
.MathJax_ExBox {display: block; overflow: hidden; width: 1px; height: 60ex}
.MathJax .MathJax_EmBox {display: block; overflow: hidden; width: 1px; height: 60em}
.MathJax .MathJax_HitBox {cursor: text; background: white; opacity: 0; filter: alpha(opacity=0)}
.MathJax .MathJax_HitBox * {filter: none; opacity: 1; background: transparent}
#MathJax_Tooltip * {filter: none; opacity: 1; background: transparent}
@font-face {font-family: MathJax_Main; src: url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/woff/MathJax_Main-Bold.woff') format('woff'), url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/otf/MathJax_Main-Bold.otf') format('opentype'); font-weight: bold}
@font-face {font-family: MathJax_Main; src: url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/woff/MathJax_Main-Italic.woff') format('woff'), url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/otf/MathJax_Main-Italic.otf') format('opentype'); font-style: italic}
@font-face {font-family: MathJax_Caligraphic; src: url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/woff/MathJax_Caligraphic-Regular.woff') format('woff'), url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/otf/MathJax_Caligraphic-Regular.otf') format('opentype')}
@font-face {font-family: MathJax_Size2; src: url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/woff/MathJax_Size2-Regular.woff') format('woff'), url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/otf/MathJax_Size2-Regular.otf') format('opentype')}
@font-face {font-family: MathJax_Size3; src: url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/woff/MathJax_Size3-Regular.woff') format('woff'), url('https://c328740.ssl.cf1.rackcdn.com/mathjax/2.3-latest/fonts/HTML-CSS/TeX/otf/MathJax_Size3-Regular.otf') format('opentype')}
.MathJax .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Hover_Arrow {position: absolute; width: 15px; height: 11px; cursor: pointer}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; color: #666666}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_Menu_Close {position: absolute; width: 31px; height: 31px; top: -15px; left: -15px}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Hover_Arrow {position: absolute; width: 15px; height: 11px; cursor: pointer}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; color: #666666}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_Menu_Close {position: absolute; width: 31px; height: 31px; top: -15px; left: -15px}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MathJax_Display {text-align: center; margin: 1em 0em; position: relative; display: block; width: 100%}
.MathJax .merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
#MathJax_Tooltip {background-color: InfoBackground; color: InfoText; border: 1px solid black; box-shadow: 2px 2px 5px #AAAAAA; -webkit-box-shadow: 2px 2px 5px #AAAAAA; -moz-box-shadow: 2px 2px 5px #AAAAAA; -khtml-box-shadow: 2px 2px 5px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true'); padding: 3px 4px; z-index: 401; position: absolute; left: 0; top: 0; width: auto; height: auto; display: none}
.MathJax {display: inline; font-style: normal; font-weight: normal; line-height: normal; font-size: 100%; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; border: 0; padding: 0; margin: 0}
.MathJax img, .MathJax nobr, .MathJax a {border: 0; padding: 0; margin: 0; max-width: none; max-height: none; vertical-align: 0; line-height: normal; text-decoration: none}
img.MathJax_strut {border: 0 !important; padding: 0 !important; margin: 0 !important; vertical-align: 0 !important}
.MathJax span {display: inline; position: static; border: 0; padding: 0; margin: 0; vertical-align: 0; line-height: normal; text-decoration: none}
.MathJax nobr {white-space: nowrap ! important}
.MathJax img {display: inline ! important; float: none ! important}
.MathJax * {transition: none; -webkit-transition: none; -moz-transition: none; -ms-transition: none; -o-transition: none}
.MathJax_Processing {visibility: hidden; position: fixed; width: 0; height: 0; overflow: hidden}
.MathJax_Processed {display: none!important}
.MathJax_ExBox {display: block; overflow: hidden; width: 1px; height: 60ex}
.MathJax .MathJax_EmBox {display: block; overflow: hidden; width: 1px; height: 60em}
.MathJax .MathJax_HitBox {cursor: text; background: white; opacity: 0; filter: alpha(opacity=0)}
.MathJax .MathJax_HitBox * {filter: none; opacity: 1; background: transparent}
#MathJax_Tooltip * {filter: none; opacity: 1; background: transparent}
@font-face {font-family: MathJax_Blank; src: url('about:blank')}
.MathJax .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Hover_Arrow {position: absolute; width: 15px; height: 11px; cursor: pointer}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; color: #666666}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_Menu_Close {position: absolute; width: 31px; height: 31px; top: -15px; left: -15px}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Hover_Arrow {position: absolute; width: 15px; height: 11px; cursor: pointer}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; color: #666666}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_Menu_Close {position: absolute; width: 31px; height: 31px; top: -15px; left: -15px}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><script id="mathJaxJS" type="text/javascript" src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/MathJax.js"></script><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Hover_Arrow {position: absolute; width: 15px; height: 11px; cursor: pointer}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; color: #666666}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_Menu_Close {position: absolute; width: 31px; height: 31px; top: -15px; left: -15px}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style></head>
<body><div id="MathJax_Message" style="display: none;"></div><div id="MathJax_Message" style="display: none;"></div><div id="MathJax_Message" style="display: none;"></div><div style="visibility: hidden; overflow: hidden; position: absolute; top: 0px; height: 1px; width: auto; padding: 0px; border: 0px; margin: 0px; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal;"><div id="MathJax_Hidden"></div></div><div id="MathJax_Message" style="display: none;"></div><div id="MathJax_Message" style="display: none;"></div><div style="visibility: hidden; overflow: hidden; position: absolute; top: 0px; height: 1px; width: auto; padding: 0px; border: 0px; margin: 0px; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal;"><div id="MathJax_Hidden"></div></div><div id="MathJax_Message" style="display: none;"></div><div id="MathJax_Message" style="display: none;"></div><div style="visibility: hidden; overflow: hidden; position: absolute; top: 0px; height: 1px; width: auto; padding: 0px; border: 0px; margin: 0px; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal;"><div id="MathJax_Hidden"></div></div><div id="MathJax_Message" style="display: none;"></div>
<div class="container closeLeft">
<div class="container_footer">
<div id="header">
<div class="wrapper">
<a href="http://www.railstutorial.org/" class="logo"><img alt="Logo" src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/logo-e741419bc04d21db7e60ddc10883b4f9.png">
</a><a href="javascript://" id="mobileMenu"><div class="closedMenu">
≡
<span>Menu</span>
</div>
<div class="openMenu">
x
<span>Close</span>
</div>
</a><div class="j_userHeader closeLeft" style="display:inline"><ul class="headerMenu">
<li><a href="http://www.softcover.io/login">Log In</a></li>
<li><a href="http://www.softcover.io/account/sign_up">Sign Up</a></li>
</ul>
</div>
<div id="dropBG" style="display: none;"></div>
<div class="clear"></div>
</div>
</div>

<div id="pageBook">
<div id="bookHeader">
<div class="wrapper">
<div class="bookCover">
<a href="http://www.railstutorial.org/book"><img alt="Cover-web" class="cover" src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/cover-web.png">
<img alt="Cover_bg" class="coverBG" src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/cover_bg-88b6816f72bba1e853bbfcd1caff472a.png">
<p>
<i class="ibooksMedia iRead"></i>
READ ONLINE FREE
</p>
</a></div>
<div class="bookInfo">
<h1>
Ruby on Rails Tutorial
<span class="j_subtitle">Learn Rails by Example</span>
<strong>Michael Hartl</strong>
</h1>
<p class="j_description">
 The Ruby on Rails Tutorial book and screencast series teach you how to develop and deploy real, industrial-strength web applications with Ruby on Rails, the open-source web framework that powers top websites such as Twitter, Hulu, GitHub, and the Yellow Pages. The Ruby on Rails Tutorial book is available for free online and is available for purchase as an ebook (PDF, EPUB, and MOBI formats). The companion screencast series includes 15 individual lessons (including a new Rails 4.0 supplement) totaling more than 15 hours, with one lesson for each chapter of the Ruby on Rails Tutorial book. The best value is the ebook/screencast bundle, which includes the 2nd edition book, the Rails 4.0–compatible version, the 2nd edition screencast series, and the Rails 4.0 supplementary screencasts. 
</p>

<div class="bookControls">
<a href="http://www.railstutorial.org/"><button class="transBG">Book Info</button>
</a><a href="mailto:admin@railstutorial.org"><button class="transBG">Contact Author</button>
</a></div>

</div>

</div>
</div>

<div id="bookMenu" class="bookMenuFixed">
<div class="wrapper">
<div class="bookMenuControls">
<div class="bookMenuArows">
<a href="javascript://" class="leftArrow">◄</a>
<a href="javascript://" class="upArrow">▲</a>
<a href="javascript://" class="rightArrow">►</a>
</div>
<div class="bookMenuSize">
<a href="javascript://" class="current" id="sizeRegular"></a>
<a href="javascript://" id="sizeBig"></a>
<a href="javascript://" id="sizeBigger"></a>
</div>
<div class="bookMenuSearch">
<a href="javascript://" id="j_singlePage"><i class="fa fa-search"></i>
Single Page
</a></div>
</div>
<div class="dropDown" id="j_chapterDropDown">
<span id="chapterTitle">Chapter 11: Following users
</span>
<ul class="dropMenu"><li><a>Frontmatter
</a></li><li><a>Chapter 1: From zero to deploy
</a></li><li><a>Chapter 2: A demo app
</a></li><li><a>Chapter 3: Mostly static pages
</a></li><li><a>Chapter 4: Rails-flavored Ruby
</a></li><li><a>Chapter 5: Filling in the layout
</a></li><li><a>Chapter 6: Modeling users
</a></li><li><a>Chapter 7: Sign up
</a></li><li><a>Chapter 8: Sign in, sign out
</a></li><li><a>Chapter 9: Updating, showing, and deleting users
</a></li><li><a>Chapter 10: User microposts
</a></li><li><a>Chapter 11: Following users
</a></li></ul>
</div>
<div class="bookMenuActions j_downloadLinks"><a href="" onclick="$(&#39;#bookMenuEmail&#39;).toggleClass(&#39;open&#39;); return false"><button class="greyButton iEmailUpdate">❤</button>
</a><a href="http://www.railstutorial.org/#pricing" class="buttonStyle attention">Buy Now</a>
<a href="http://www.softcover.io/downloads/28fdb94f/ruby_on_rails_tutorial"><button>Download Previews</button>
</a></div>
</div>
<div class="animated" id="bookMenuEmail">
<div class="wrapper">
<label>Follow this book to receive email updates from the author.</label>
<div class="j_followBookForm"><form accept-charset="UTF-8" action="http://www.softcover.io/follow/28fdb94f/ruby_on_rails_tutorial" method="get"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="✓"></div>
<input name="email" placeholder="YOUR EMAIL ADDRESS" type="text">
<input class="greyButton optClick_follow" type="submit" value="Follow Book">
</form>

</div>
</div>
</div>
</div>
<div class="wrapper" id="bookWr">
<div class="bookChapterTop">Chapter 11: Following users
</div>
<div id="bookHtml" style="opacity: 1;"><div id="book"><div id="_cha-following_users" data-tralics-id="cid65" class="chapter" data-number="11" data-chapter="following_users"><h1><a href="http://www.railstutorial.org/book/following_users#cha-following_users" class="heading hyperref"><span class="number">Chapter 11 </span>Following users</a></h1>
<p>In this chapter, we will complete the core sample application by adding a social layer that allows users to follow (and unfollow) other users, resulting in each user’s Home page displaying a status feed of the followed users’ microposts.<span class="intersentencespace"></span> We will also make views to display both a user’s followers and the users each user is following.<span class="intersentencespace"></span> We will learn how to model relationships between users in <a href="http://www.railstutorial.org/book/following_users#sec-the_relationship_model" class="hyperref">Section&nbsp;<span class="ref">11.1</span></a>, and then make the web interface in <a href="http://www.railstutorial.org/book/following_users#sec-a_web_interface_for_following_and_followers" class="hyperref">Section&nbsp;<span class="ref">11.2</span></a> (including an introduction to Ajax).<span class="intersentencespace"></span> Finally, we’ll end by developing a fully functional status feed in <a href="http://www.railstutorial.org/book/following_users#sec-the_status_feed" class="hyperref">Section&nbsp;<span class="ref">11.3</span></a>.</p>
<p>This final chapter contains some of the most challenging material in the tutorial, including some Ruby/SQL trickery to make the status feed.<span class="intersentencespace"></span> Through these examples, you will see how Rails can handle even rather intricate data models, which should serve you well as you go on to develop your own applications with their own specific requirements.<span class="intersentencespace"></span> To help with the transition from tutorial to independent development, <a href="http://www.railstutorial.org/book/following_users#sec-following_conclusion" class="hyperref">Section&nbsp;<span class="ref">11.4</span></a> contains suggested extensions to the core sample application, along with pointers to more advanced resources.</p>
<p>As usual, Git users should create a new topic branch:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b following-users
</pre></div></div>
<p>Because the material in this chapter is particularly challenging, before writing any code we’ll pause for a moment and take a tour of the interface.<span class="intersentencespace"></span> As in previous chapters, at this early stage we’ll represent pages using mockups.<sup id="_cha-11_footnote-ref-1" class="footnote intersentence"><a href="http://www.railstutorial.org/book/following_users#cha-11_footnote-1">1</a></sup><span class="intersentencespace"></span> The full page flow runs as follows: a user (John Calvin) starts at his profile page (<a href="http://www.railstutorial.org/book/following_users#fig-page_flow_profile_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.1</span></a>) and navigates to the Users page (<a href="http://www.railstutorial.org/book/following_users#fig-page_flow_user_index_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.2</span></a>) to select a user to follow.<span class="intersentencespace"></span> Calvin navigates to the profile of a second user, Thomas Hobbes (<a href="http://www.railstutorial.org/book/following_users#fig-page_flow_other_profile_follow_button_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.3</span></a>), clicking on the “Follow” button to follow that user.<span class="intersentencespace"></span> This changes the “Follow” button to “Unfollow”, and increments Hobbes’s “followers” count by one (<a href="http://www.railstutorial.org/book/following_users#fig-page_flow_other_profile_unfollow_button_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.4</span></a>).<span class="intersentencespace"></span> Navigating to his home page, Calvin now sees an incremented “following” count and finds Hobbes’s microposts in his status feed (<a href="http://www.railstutorial.org/book/following_users#fig-page_flow_home_page_feed_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.5</span></a>).<span class="intersentencespace"></span> The rest of this chapter is dedicated to making this page flow actually work.</p>
<div class="center figure" id="_fig-page_flow_profile_mockup" data-tralics-id="uid867" data-number="11.1">
<div class="graphics image box"><img src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/page_flow_profile_mockup_bootstrap.png" alt="images/figures/page_flow_profile_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 11.1: </span><span class="description">The current user’s profile.
</span></div></div>
<div class="center figure" id="_fig-page_flow_user_index_mockup" data-tralics-id="uid868" data-number="11.2">
<div class="graphics image box"><img src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/page_flow_user_index_mockup_bootstrap.png" alt="images/figures/page_flow_user_index_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 11.2: </span><span class="description">Finding a user to follow.
</span></div></div>
<div class="center figure" id="_fig-page_flow_other_profile_follow_button_mockup" data-tralics-id="uid869" data-number="11.3">
<div class="graphics image box"><img src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/page_flow_other_profile_follow_button_mockup_bootstrap.png" alt="images/figures/page_flow_other_profile_follow_button_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 11.3: </span><span class="description">The profile of a user to follow, with a follow button.
</span></div></div>
<div class="center figure" id="_fig-page_flow_other_profile_unfollow_button_mockup" data-tralics-id="uid870" data-number="11.4">
<div class="graphics image box"><img src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/page_flow_other_profile_unfollow_button_mockup_bootstrap.png" alt="images/figures/page_flow_other_profile_unfollow_button_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 11.4: </span><span class="description">A profile with an unfollow button and incremented followers count.
</span></div></div>
<div class="center figure" id="_fig-page_flow_home_page_feed_mockup" data-tralics-id="uid871" data-number="11.5">
<div class="graphics image box"><img src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/page_flow_home_page_feed_mockup_bootstrap.png" alt="images/figures/page_flow_home_page_feed_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 11.5: </span><span class="description">The Home page with status feed and incremented following count.
</span></div></div>
</div><div id="_sec-the_relationship_model" data-tralics-id="cid66" class="section" data-number="11.1"><h2><a href="http://www.railstutorial.org/book/following_users#sec-the_relationship_model" class="heading hyperref"><span class="number">11.1 </span>The Relationship model</a></h2>
<p>Our first step in implementing following users is to construct a data model, which is not as straightforward as it seems.<span class="intersentencespace"></span> Naïvely, it seems that a <code>has_many</code> relationship should do: a user <code>has_many</code> followed users and <code>has_many</code> followers.<span class="intersentencespace"></span> As we will see, there is a problem with this approach, and we’ll learn how to fix it using <code>has_many through</code>.<span class="intersentencespace"></span> It’s likely that many of the ideas in this section won’t seem obvious at first, and it may take a while for the rather complicated data model to sink in.<span class="intersentencespace"></span> If you find yourself getting confused, try pushing forward to the end; then, read the section a second time through to see if things are clearer.</p>
<div id="_sec-a_problem_with_the_data_model" data-tralics-id="uid872" class="subsection" data-number="11.1.1"><h3><a href="http://www.railstutorial.org/book/following_users#sec-a_problem_with_the_data_model" class="heading hyperref"><span class="number">11.1.1 </span>A problem with the data model (and a solution)</a></h3>
<p>As a first step toward constructing a data model for following users, let’s examine a typical case.<span class="intersentencespace"></span> For instance, consider a user who follows a second user: we could say that, e.g., Calvin is following Hobbes, and Hobbes is followed by Calvin, so that Calvin is the <em>follower</em> and Hobbes is <em>followed</em>.<span class="intersentencespace"></span> Using Rails’ default pluralization convention, the set of all users following a given user is that user’s <em>followers</em>, and <code>user.followers</code> is an array of those users.<span class="intersentencespace"></span> Unfortunately, the reverse doesn’t work: by default, the set of all followed users would be called the <em>followeds</em>, which is ungrammatical and clumsy.<span class="intersentencespace"></span> We could call them <em>following</em>, but that’s ambiguous: in normal English, a “following” is the set of people following <em>you</em>, i.e., your followers—exactly the opposite of the intended meaning.<span class="intersentencespace"></span> Although we will use “following” as a label, as in “50 following, 75 followers”, we’ll use “followed users” for the users themselves, with a corresponding <code>user.followed_users</code> array.<sup id="_cha-11_footnote-ref-2" class="footnote"><a href="http://www.railstutorial.org/book/following_users#cha-11_footnote-2">2</a></sup></p>
<p>This discussion suggests modeling the followed users as in <a href="http://www.railstutorial.org/book/following_users#fig-naive_user_has_many_following" class="hyperref">Figure&nbsp;<span class="ref">11.6</span></a>, with a <code>followed_users</code> table and a <code>has_many</code> association.<span class="intersentencespace"></span> Since <code>user.followed_users</code> should be an array of users, each row of the <code>followed_users</code> table would need to be a user, as identified by the <code>followed_id</code>, together with the <code>follower_id</code> to establish the association.<sup id="_cha-11_footnote-ref-3" class="footnote intersentence"><a href="http://www.railstutorial.org/book/following_users#cha-11_footnote-3">3</a></sup><span class="intersentencespace"></span> In addition, since each row is a user, we would need to include the user’s other attributes, including the name, password, etc.</p>
<div class="center figure" id="_fig-naive_user_has_many_following" data-tralics-id="uid875" data-number="11.6">
<div class="graphics image box"><img src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/naive_user_has_many_followed_users.png" alt="images/figures/naive_user_has_many_followed_users"></div><div class="caption"><span class="header">Figure 11.6: </span><span class="description">A naïve implementation of user following.
</span></div></div>
<p>The problem with the data model in <a href="http://www.railstutorial.org/book/following_users#fig-naive_user_has_many_following" class="hyperref">Figure&nbsp;<span class="ref">11.6</span></a> is that it is terribly redundant: each row contains not only each followed user’s id, but all their other information as well—all of which are <em>already</em> in the <code>users</code> table.<span class="intersentencespace"></span> Even worse, to model user <em>followers</em> we would need a separate, similarly redundant <code>followers</code> table.<span class="intersentencespace"></span> Finally, this data model is a maintainability nightmare: each time a user changed (say) their name, we would need to update not just the user’s record in the <code>users</code> table but also <em>every row containing that user</em>
in both the <code>followed_users</code> and <code>followers</code> tables.</p>
<p>The problem here is that we are missing an underlying abstraction.<span class="intersentencespace"></span> One way to find the proper abstraction is to consider how we might implement the act of <em>following</em> in a web application.<span class="intersentencespace"></span> Recall from <a href="http://www.railstutorial.org/book/sign_up#sec-a_users_resource" class="hyperref">Section&nbsp;<span class="ref">7.1.2</span></a> that the REST architecture involves <em>resources</em> that are created and destroyed.<span class="intersentencespace"></span> This leads us to ask two questions: When a user follows another user, what is being created?<span class="intersentencespace"></span> When a user <em>un</em>follows another user, what is being destroyed?</p>
<p>Upon reflection, we see that in these cases the application should either create or destroy a <em>relationship</em> between two users.<span class="intersentencespace"></span> A user then <code>has_many :relationships</code>, and has many <code>followed_users</code> (or <code>followers</code>) <em>through</em> these relationships.<span class="intersentencespace"></span> Indeed, <a href="http://www.railstutorial.org/book/following_users#fig-naive_user_has_many_following" class="hyperref">Figure&nbsp;<span class="ref">11.6</span></a> already contains most of the implementation: since each followed user is uniquely identified by <code>followed_id</code>, we could convert <code>followed_users</code> to a <code>relationships</code> table, omit the user details, and use <code>followed_id</code> to retrieve the followed user from the <code>users</code> table.<span class="intersentencespace"></span> Moreover, by considering <em>reverse</em> relationships, we could use the <code>follower_id</code> column to extract an array of user’s followers.</p>
<p>To make a <code>followed_users</code> array of users, it would be possible to pull out an array of <code>followed_id</code> attributes and then find the user for each one.<span class="intersentencespace"></span> As you might expect, though, Rails has a way to make this procedure more convenient, and the relevant technique is known as <code>has_many through</code>.<span class="intersentencespace"></span> As we will see in <a href="http://www.railstutorial.org/book/following_users#sec-following" class="hyperref">Section&nbsp;<span class="ref">11.1.4</span></a>, Rails allows us to say that a user is following many users <em>through</em> the relationships table, using the succinct code</p>
<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followed_users</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">source</span><span class="p">:</span> <span class="ss">:followed</span>
</pre></div></div>
<p>This code automatically populates <code>user.followed_users</code> with an array of followed users.<span class="intersentencespace"></span> A diagram of the data model appears in <a href="http://www.railstutorial.org/book/following_users#fig-user_has_many_following" class="hyperref">Figure&nbsp;<span class="ref">11.7</span></a>.</p>
<div class="center figure" id="_fig-user_has_many_following" data-tralics-id="uid876" data-number="11.7">
<div class="graphics image box"><img src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/user_has_many_followed_users.png" alt="images/figures/user_has_many_followed_users"></div><div class="caption"><span class="header">Figure 11.7: </span><span class="description">A model of followed users through user relationships.
</span></div></div>
<p>To get started with the implementation, we first generate a Relationship model as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model Relationship follower_id:integer followed_id:integer
</pre></div></div>
<p>It’s possible that this will generate a Relationship factory, which you should remove:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rm -f spec/factories/relationship.rb
</pre></div></div>
<p>Since we will be finding relationships by <code>follower_id</code> and by <code>followed_id</code>, we should add an index on each column for efficiency, as shown in <a href="http://www.railstutorial.org/book/following_users#code-relationships_migration" class="hyperref">Listing&nbsp;<span class="ref">11.1</span></a>.</p>
<div class="codelisting" id="_code-relationships_migration" data-tralics-id="uid877" data-number="11.1"><div class="heading"><span class="number">Listing 11.1:</span> 

<span class="description">Adding indices for the <code>relationships</code> table.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/migrate/[timestamp]_create_relationships.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateRelationships</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:relationships</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:follower_id</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:followed_id</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:follower_id</span>
    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:followed_id</span>
    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="o">[</span><span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">:followed_id</span><span class="o">]</span><span class="p">,</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p><a href="http://www.railstutorial.org/book/following_users#code-relationships_migration" class="hyperref">Listing&nbsp;<span class="ref">11.1</span></a> also includes a <em>composite</em> index that enforces uniqueness of pairs of (<code>follower_id</code>, <code>followed_id</code>), so that a user can’t follow another user more than once:</p>
<div class="code"><div class="highlight"><pre><span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="o">[</span><span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">:followed_id</span><span class="o">]</span><span class="p">,</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span>
</pre></div></div>
<p>(Compare to the email uniqueness index from <a href="http://www.railstutorial.org/book/modeling_users#code-email_uniqueness_index" class="hyperref">Listing&nbsp;<span class="ref">6.19</span></a>.)<span class="intersentencespace"></span> As we’ll see starting in <a href="http://www.railstutorial.org/book/following_users#sec-following" class="hyperref">Section&nbsp;<span class="ref">11.1.4</span></a>, our user interface won’t allow this to happen, but adding a unique index arranges to raise an error if a user tries to create duplicate relationships anyway (using, e.g., a command-line tool such as <span class="tt">curl</span>).<span class="intersentencespace"></span> We will add a uniqueness validation to the Relationship model, but because it is <em>always</em> an error to create duplicate relationships, the unique index is sufficient for now.</p>
<p>To create the <code>relationships</code> table, we migrate the database and prepare the test database as usual:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div></div>
<p>The result is the Relationship data model shown in <a href="http://www.railstutorial.org/book/following_users#fig-relationship_model" class="hyperref">Figure&nbsp;<span class="ref">11.8</span></a>.</p>
<div class="center figure" id="_fig-relationship_model" data-tralics-id="uid878" data-number="11.8">
<div class="graphics image box"><img src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/relationship_model.png" alt="images/figures/relationship_model"></div><div class="caption"><span class="header">Figure 11.8: </span><span class="description">The Relationship data model.
</span></div></div>
</div>
<div id="_sec-relationship_user_associations" data-tralics-id="uid879" class="subsection" data-number="11.1.2"><h3><a href="http://www.railstutorial.org/book/following_users#sec-relationship_user_associations" class="heading hyperref"><span class="number">11.1.2 </span>User/relationship associations</a></h3>
<p>Before implementing followed users and followers, we first need to establish the association between users and relationships.<span class="intersentencespace"></span> A user <code>has_many</code> relationships, and—since relationships involve <em>two</em> users—a relationship <code>belongs_to</code> both a follower and a followed user.</p>
<p>As with microposts in <a href="http://www.railstutorial.org/book/user_microposts#sec-user_micropost_associations" class="hyperref">Section&nbsp;<span class="ref">10.1.3</span></a>, we will create new relationships using the user association, with code such as</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">followed_id</span><span class="p">:</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div></div>
<p>We start with a basic validity test, shown in <a href="http://www.railstutorial.org/book/following_users#code-relationship_create_test" class="hyperref">Listing&nbsp;<span class="ref">11.2</span></a>.</p>
<div class="codelisting" id="_code-relationship_create_test" data-tralics-id="uid880" data-number="11.2"><div class="heading"><span class="number">Listing 11.2:</span> 

<span class="description">Testing Relationship creation and attributes.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/relationship_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">Relationship</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:follower</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:followed</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:relationship</span><span class="p">)</span> <span class="p">{</span> <span class="n">follower</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">followed_id</span><span class="p">:</span> <span class="n">followed</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">relationship</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that, unlike the tests for the User and Micropost models, which use <code>@user</code> and <code>@micropost</code>, respectively, <a href="http://www.railstutorial.org/book/following_users#code-relationship_create_test" class="hyperref">Listing&nbsp;<span class="ref">11.2</span></a> uses <code>let</code> in preference to an instance variable.<span class="intersentencespace"></span> The differences rarely matter,<sup id="_cha-11_footnote-ref-4" class="footnote"><a href="http://www.railstutorial.org/book/following_users#cha-11_footnote-4">4</a></sup> but I consider <code>let</code> to be cleaner than using an instance variable.<span class="intersentencespace"></span> We originally used instance variables both because instance variables are important to introduce early and because <code>let</code> is a little more advanced.</p>
<p>We should also test the User model for a <code>relationships</code> attribute, as shown in <a href="http://www.railstutorial.org/book/following_users#code-user_relationships_method_test" class="hyperref">Listing&nbsp;<span class="ref">11.3</span></a>.</p>
<div class="codelisting" id="_code-user_relationships_method_test" data-tralics-id="uid882" data-number="11.3"><div class="heading"><span class="number">Listing 11.3:</span> 

<span class="description">Testing for the <code>user.relationships</code> attribute.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:relationships</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>At this point, you might expect application code as in <a href="http://www.railstutorial.org/book/user_microposts#sec-user_micropost_associations" class="hyperref">Section&nbsp;<span class="ref">10.1.3</span></a>, and it’s similar, but there is one critical difference: in the case of the Micropost model, we could say</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
<p>and</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
<p>because the <code>microposts</code> table has a <code>user_id</code> attribute to identify the user (<a href="http://www.railstutorial.org/book/user_microposts#sec-the_basic_model" class="hyperref">Section&nbsp;<span class="ref">10.1.1</span></a>).<span class="intersentencespace"></span> An id used in this manner to connect two database tables is known as a <em>foreign key</em>, and when the foreign key for a User model object is <code>user_id</code>, Rails infers the association automatically: by default, Rails expects a foreign key of the form <code>&lt;class&gt;_id</code>, where <code>&lt;class&gt;</code> is the lower-case version of the class name.<sup id="_cha-11_footnote-ref-5" class="footnote intersentence"><a href="http://www.railstutorial.org/book/following_users#cha-11_footnote-5">5</a></sup><span class="intersentencespace"></span> In the present case, although we are still dealing with users, they are now identified with the foreign key <code>follower_id</code>, so we have to tell that to Rails, as shown in <a href="http://www.railstutorial.org/book/following_users#code-user_relationships_association" class="hyperref">Listing&nbsp;<span class="ref">11.4</span></a>.<sup id="_cha-11_footnote-ref-6" class="footnote"><a href="http://www.railstutorial.org/book/following_users#cha-11_footnote-6">6</a></sup></p>
<div class="codelisting" id="_code-user_relationships_association" data-tralics-id="uid885" data-number="11.4"><div class="heading"><span class="number">Listing 11.4:</span> 

<span class="description">Implementing the user/relationships <code>has_many</code> association.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="n">foreign_key</span><span class="p">:</span> <span class="s2">"follower_id"</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>(Since destroying a user should also destroy that user’s relationships, we’ve gone ahead and added <code>dependent: :destroy</code> to the association; writing a test for this is left as an exercise (<a href="http://www.railstutorial.org/book/following_users#sec-following_exercises" class="hyperref">Section&nbsp;<span class="ref">11.5</span></a>).)</p>
<p>As with the Micropost model, the Relationship model has a <code>belongs_to</code> relationship with users; in this case, a relationship object belongs to both a <code>follower</code> and a <code>followed</code> user, which we test for in <a href="http://www.railstutorial.org/book/following_users#code-relationships_belongs_to_test" class="hyperref">Listing&nbsp;<span class="ref">11.5</span></a>.</p>
<div class="codelisting" id="_code-relationships_belongs_to_test" data-tralics-id="uid886" data-number="11.5"><div class="heading"><span class="number">Listing 11.5:</span> 

<span class="description">Testing the user/relationships <code>belongs_to</code> association.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/relationship_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">Relationship</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"follower methods"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:follower</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:follower</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="n">eq</span> <span class="n">follower</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:followed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="n">eq</span> <span class="n">followed</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>To write the application code, we define the <code>belongs_to</code> relationship as usual.<span class="intersentencespace"></span> Rails infers the names of the foreign keys from the corresponding symbols (i.e., <code>follower_id</code> from <code>:follower</code>, and <code>followed_id</code> from <code>:followed</code>), but since there is neither a Followed nor a Follower model we need to supply the class name <code>User</code>.<span class="intersentencespace"></span> The result is shown in <a href="http://www.railstutorial.org/book/following_users#code-relationship_belongs_to" class="hyperref">Listing&nbsp;<span class="ref">11.6</span></a>.<span class="intersentencespace"></span> Note that, unlike the default generated Relationship model, in this case only the <code>followed_id</code> is accessible.</p>
<div class="codelisting" id="_code-relationship_belongs_to" data-tralics-id="uid887" data-number="11.6"><div class="heading"><span class="number">Listing 11.6:</span> 

<span class="description">Adding the <code>belongs_to</code> associations to the Relationship model.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/relationship.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">belongs_to</span> <span class="ss">:follower</span><span class="p">,</span> <span class="n">class_name</span><span class="p">:</span> <span class="s2">"User"</span>
  <span class="n">belongs_to</span> <span class="ss">:followed</span><span class="p">,</span> <span class="n">class_name</span><span class="p">:</span> <span class="s2">"User"</span>
<span class="k">end</span>
</pre></div></div></div><p>The <code>followed</code> association isn’t actually needed until <a href="http://www.railstutorial.org/book/following_users#sec-followers" class="hyperref">Section&nbsp;<span class="ref">11.1.5</span></a>, but the parallel follower/followed structure is clearer if we implement them both at the same time.</p>
<p>At this point, the tests in <a href="http://www.railstutorial.org/book/following_users#code-relationship_create_test" class="hyperref">Listing&nbsp;<span class="ref">11.2</span></a> and <a href="http://www.railstutorial.org/book/following_users#code-user_relationships_method_test" class="hyperref">Listing&nbsp;<span class="ref">11.3</span></a> should pass.</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div>
<div id="_sec-relationship_validations" data-tralics-id="uid888" class="subsection" data-number="11.1.3"><h3><a href="http://www.railstutorial.org/book/following_users#sec-relationship_validations" class="heading hyperref"><span class="number">11.1.3 </span>Validations</a></h3>
<p>Before moving on, we’ll add a couple of Relationship model validations for completeness.<span class="intersentencespace"></span> The tests (<a href="http://www.railstutorial.org/book/following_users#code-relationship_validation_tests" class="hyperref">Listing&nbsp;<span class="ref">11.7</span></a>) and application code (<a href="http://www.railstutorial.org/book/following_users#code-relationship_validations" class="hyperref">Listing&nbsp;<span class="ref">11.8</span></a>) are straightforward.</p>
<div class="codelisting" id="_code-relationship_validation_tests" data-tralics-id="uid889" data-number="11.7"><div class="heading"><span class="number">Listing 11.7:</span> 

<span class="description">Testing the Relationship model validations.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/relationship_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">Relationship</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"when followed id is not present"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">relationship</span><span class="o">.</span><span class="n">followed_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"when follower id is not present"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">relationship</span><span class="o">.</span><span class="n">follower_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-relationship_validations" data-tralics-id="uid890" data-number="11.8"><div class="heading"><span class="number">Listing 11.8:</span> 

<span class="description">Adding the Relationship model validations.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/relationship.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">belongs_to</span> <span class="ss">:follower</span><span class="p">,</span> <span class="n">class_name</span><span class="p">:</span> <span class="s2">"User"</span>
  <span class="n">belongs_to</span> <span class="ss">:followed</span><span class="p">,</span> <span class="n">class_name</span><span class="p">:</span> <span class="s2">"User"</span>
  <span class="n">validates</span> <span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:followed_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div></div>
<div id="_sec-following" data-tralics-id="uid891" class="subsection" data-number="11.1.4"><h3><a href="http://www.railstutorial.org/book/following_users#sec-following" class="heading hyperref"><span class="number">11.1.4 </span>Followed users</a></h3>
<p>We come now to the heart of the Relationship associations: <code>followed_users</code> and <code>followers</code>.<span class="intersentencespace"></span> We start with <code>followed_users</code>, as shown in <a href="http://www.railstutorial.org/book/following_users#code-user_following_test" class="hyperref">Listing&nbsp;<span class="ref">11.9</span></a>.</p>
<div class="codelisting" id="_code-user_following_test" data-tralics-id="uid892" data-number="11.9"><div class="heading"><span class="number">Listing 11.9:</span> 

<span class="description">A test for the <code>user.followed_users</code> attribute.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:relationships</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The implementation uses <code>has_many through</code> for the first time: a user has many following <em>through</em> relationships, as illustrated in <a href="http://www.railstutorial.org/book/following_users#fig-user_has_many_following" class="hyperref">Figure&nbsp;<span class="ref">11.7</span></a>.<span class="intersentencespace"></span> By default, in a <code>has_many through</code> association Rails looks for a foreign key corresponding to the singular version of the association; in other words, code like</p>
<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followeds</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:relationships</span>
</pre></div></div>
<p>would assemble an array using the <code>followed_id</code> in the <code>relationships</code> table.<span class="intersentencespace"></span> But, as noted in <a href="http://www.railstutorial.org/book/following_users#sec-a_problem_with_the_data_model" class="hyperref">Section&nbsp;<span class="ref">11.1.1</span></a>, <code>user.followeds</code> is rather awkward; far more natural is to use “followed users” as a plural of “followed”, and write instead <code>user.followed_users</code> for the array of followed users.<span class="intersentencespace"></span> Naturally, Rails allows us to override the default, in this case using the <code>:source</code> parameter (<a href="http://www.railstutorial.org/book/following_users#code-has_many_following_through_relationships" class="hyperref">Listing&nbsp;<span class="ref">11.10</span></a>), which explicitly tells Rails that the source of the <code>followed_users</code> array is the set of <code>followed</code>&nbsp;ids.</p>
<div class="codelisting" id="_code-has_many_following_through_relationships" data-tralics-id="uid893" data-number="11.10"><div class="heading"><span class="number">Listing 11.10:</span> 

<span class="description">Adding the User model <code>followed_users</code> association.<span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="n">foreign_key</span><span class="p">:</span> <span class="s2">"follower_id"</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:followed_users</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">source</span><span class="p">:</span> <span class="ss">:followed</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>To create a following relationship, we’ll introduce a <code>follow!</code> utility method so that we can write <code>user.follow!(other_user)</code>.<span class="intersentencespace"></span> (This <code>follow!</code> method should always work, so, as with <code>create!</code> and <code>save!</code>, we indicate with an exclamation point that an exception will be raised on failure.)<span class="intersentencespace"></span> We’ll also add an associated <code>following?</code> boolean method to test if one user is following another.<sup id="_cha-11_footnote-ref-7" class="footnote intersentence"><a href="http://www.railstutorial.org/book/following_users#cha-11_footnote-7">7</a></sup><span class="intersentencespace"></span> The tests in <a href="http://www.railstutorial.org/book/following_users#code-utility_method_tests" class="hyperref">Listing&nbsp;<span class="ref">11.11</span></a> show how we expect these methods to be used in practice.</p>
<div class="codelisting" id="_code-utility_method_tests" data-tralics-id="uid895" data-number="11.11"><div class="heading"><span class="number">Listing 11.11:</span> 

<span class="description">Tests for some “following” utility methods.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:following?</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:follow!</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"following"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_following</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>In the application code, the <code>following?</code> method takes in a user, called <code>other_user</code>, and checks to see if a followed user with that id exists in the database; the <code>follow!</code> method calls <code>create!</code> through the <code>relationships</code> association to create the following relationship.<span class="intersentencespace"></span> The results appear in <a href="http://www.railstutorial.org/book/following_users#code-following_p_follow_bang" class="hyperref">Listing&nbsp;<span class="ref">11.12</span></a>.</p>
<div class="codelisting" id="_code-following_p_follow_bang" data-tralics-id="uid896" data-number="11.12"><div class="heading"><span class="number">Listing 11.12:</span> 

<span class="description">The <code>following?</code> and <code>follow!</code> utility methods.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">following?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="n">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="n">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that in <a href="http://www.railstutorial.org/book/following_users#code-following_p_follow_bang" class="hyperref">Listing&nbsp;<span class="ref">11.12</span></a> we have omitted the user itself, writing just</p>
<div class="code"><div class="highlight"><pre><span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div></div>
<p>instead of the equivalent code</p>
<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div></div>
<p>Whether to include the explicit <code>self</code> is largely a matter of taste.</p>
<p>Of course, users should be able to unfollow other users as well as follow them, which leads to the somewhat predictable <code>unfollow!</code> method, as shown in <a href="http://www.railstutorial.org/book/following_users#code-user_unfollow_test" class="hyperref">Listing&nbsp;<span class="ref">11.13</span></a>.</p>
<div class="codelisting" id="_code-user_unfollow_test" data-tralics-id="uid897" data-number="11.13"><div class="heading"><span class="number">Listing 11.13:</span> 

<span class="description">A test for unfollowing a user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:follow!</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:unfollow!</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"following"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"and unfollowing"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_following</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The code for <code>unfollow!</code> is straightforward: just find the relationship by followed&nbsp;id and destroy it (<a href="http://www.railstutorial.org/book/following_users#code-user_unfollow" class="hyperref">Listing&nbsp;<span class="ref">11.14</span></a>).</p>
<div class="codelisting" id="_code-user_unfollow" data-tralics-id="uid898" data-number="11.14"><div class="heading"><span class="number">Listing 11.14:</span> 

<span class="description">Unfollowing a user by destroying a user relationship.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">following?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="n">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="n">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">unfollow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="n">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div></div>
<div id="_sec-followers" data-tralics-id="uid899" class="subsection" data-number="11.1.5"><h3><a href="http://www.railstutorial.org/book/following_users#sec-followers" class="heading hyperref"><span class="number">11.1.5 </span>Followers</a></h3>
<p>The final piece of the relationships puzzle is to add a <code>user.followers</code> method to go with <code>user.followed_users</code>.<span class="intersentencespace"></span> You may have noticed from <a href="http://www.railstutorial.org/book/following_users#fig-user_has_many_following" class="hyperref">Figure&nbsp;<span class="ref">11.7</span></a> that all the information needed to extract an array of followers is already present in the <code>relationships</code> table.<span class="intersentencespace"></span> Indeed, the technique is exactly the same as for user following, with the roles of <code>follower_id</code> and <code>followed_id</code> reversed.<span class="intersentencespace"></span> This suggests that, if we could somehow arrange for a <code>reverse_relationships</code> table with those two columns reversed (<a href="http://www.railstutorial.org/book/following_users#fig-user_has_many_followers" class="hyperref">Figure&nbsp;<span class="ref">11.9</span></a>), we could implement <code>user.followers</code> with little effort.</p>
<div class="center figure" id="_fig-user_has_many_followers" data-tralics-id="uid900" data-number="11.9">
<div class="graphics image box"><img src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/user_has_many_followers_2nd_ed.png" alt="images/figures/user_has_many_followers_2nd_ed"></div><div class="caption"><span class="header">Figure 11.9: </span><span class="description">A model for user followers using a reverse Relationship model.
</span></div></div>
<p>We begin with the tests, having faith that the magic of Rails will come to the rescue (<a href="http://www.railstutorial.org/book/following_users#code-reverse_relationships_test" class="hyperref">Listing&nbsp;<span class="ref">11.15</span></a>).</p>
<div class="codelisting" id="_code-reverse_relationships_test" data-tralics-id="uid901" data-number="11.15"><div class="heading"><span class="number">Listing 11.15:</span> 

<span class="description">Testing for reverse relationships.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:relationships</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:reverse_relationships</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followers</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>

  <span class="n">describe</span> <span class="s2">"following"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_following</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"followed user"</span> <span class="k">do</span>
      <span class="n">subject</span> <span class="p">{</span> <span class="n">other_user</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:followers</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Notice how we switch subjects using the <code>subject</code> method, replacing <code>@user</code> with <code>other_user</code>, allowing us to test the follower relationship in a natural way:</p>
<div class="code"><div class="highlight"><pre><span class="n">subject</span> <span class="p">{</span> <span class="n">other_user</span> <span class="p">}</span>
<span class="n">its</span><span class="p">(</span><span class="ss">:followers</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>
<p>As you probably suspect, we will not be making a whole database table just to hold reverse relationships.<span class="intersentencespace"></span> Instead, we will exploit the underlying symmetry between followers and followed users to simulate a <code>reverse_relationships</code> table by passing <code>followed_id</code> as the primary key.<span class="intersentencespace"></span> In other words, where the <code>relationships</code> association uses the <code>follower_id</code> foreign key,</p>
<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="n">foreign_key</span><span class="p">:</span> <span class="s2">"follower_id"</span>
</pre></div></div>
<p>the <code>reverse_relationships</code> association uses <code>followed_id</code>:</p>
<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="n">foreign_key</span><span class="p">:</span> <span class="s2">"followed_id"</span>
</pre></div></div>
<p>The <code>followers</code> association then gets built through the reverse relationships, as shown in <a href="http://www.railstutorial.org/book/following_users#code-user_reverse_relationships" class="hyperref">Listing&nbsp;<span class="ref">11.16</span></a>.</p>
<div class="codelisting" id="_code-user_reverse_relationships" data-tralics-id="uid902" data-number="11.16"><div class="heading"><span class="number">Listing 11.16:</span> 

<span class="description">Implementing <code>user.followers</code> using reverse relationships.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">has_many</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="n">foreign_key</span><span class="p">:</span> <span class="s2">"followed_id"</span><span class="p">,</span>
                                   <span class="n">class_name</span><span class="p">:</span>  <span class="s2">"Relationship"</span><span class="p">,</span>
                                   <span class="ss">dependent</span><span class="p">:</span>   <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">source</span><span class="p">:</span> <span class="ss">:follower</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>(As with <a href="http://www.railstutorial.org/book/following_users#code-user_relationships_association" class="hyperref">Listing&nbsp;<span class="ref">11.4</span></a>, the test for <code>dependent :destroy</code> is left as an exercise (<a href="http://www.railstutorial.org/book/following_users#sec-following_exercises" class="hyperref">Section&nbsp;<span class="ref">11.5</span></a>).)<span class="intersentencespace"></span> Note that we actually have to include the <em>class</em> name for this association, i.e.,</p>
<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="n">foreign_key</span><span class="p">:</span> <span class="s2">"followed_id"</span><span class="p">,</span>
                                 <span class="n">class_name</span><span class="p">:</span> <span class="s2">"Relationship"</span>
</pre></div></div>
<p>because otherwise Rails would look for a <code>ReverseRelationship</code> class, which doesn’t exist.</p>
<p>It’s also worth noting that we could actually omit the <code>:source</code> key in this case, using simply</p>
<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:reverse_relationships</span>
</pre></div></div>
<p>since, in the case of a <code>:followers</code> attribute, Rails will singularize “followers” and automatically look for the foreign key <code>follower_id</code> in this case.<span class="intersentencespace"></span> I’ve kept the <code>:source</code> key to emphasize the parallel structure with the <code>has_many :followed_users</code> association, but you are free to leave it off.</p>
<p>With the code in <a href="http://www.railstutorial.org/book/following_users#code-user_reverse_relationships" class="hyperref">Listing&nbsp;<span class="ref">11.16</span></a>, the following/follower associations are complete, and all the tests should pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<p>This section has placed rather heavy demands on your data modeling skills, and it’s fine if it takes a while to soak in.<span class="intersentencespace"></span> In fact, one of the best ways to understand the associations is to use them in the web interface, as seen in the next section.</p>
</div></div><div id="_sec-a_web_interface_for_following_and_followers" data-tralics-id="cid67" class="section" data-number="11.2"><h2><a href="http://www.railstutorial.org/book/following_users#sec-a_web_interface_for_following_and_followers" class="heading hyperref"><span class="number">11.2 </span>A web interface for following users</a></h2>
<p>In the introduction to this chapter, we saw a preview of the page flow for user following.<span class="intersentencespace"></span> In this section, we will implement the basic interface and following/unfollowing functionality shown in those mockups.<span class="intersentencespace"></span> We will also make separate pages to show the user following and followers arrays.<span class="intersentencespace"></span> In <a href="http://www.railstutorial.org/book/following_users#sec-the_status_feed" class="hyperref">Section&nbsp;<span class="ref">11.3</span></a>, we’ll complete our sample application by adding the user’s status feed.</p>
<div id="_sec-sample_following_data" data-tralics-id="uid903" class="subsection" data-number="11.2.1"><h3><a href="http://www.railstutorial.org/book/following_users#sec-sample_following_data" class="heading hyperref"><span class="number">11.2.1 </span>Sample following data</a></h3>
<p>As in previous chapters, we will find it convenient to use the sample data Rake task to fill the database with sample relationships.<span class="intersentencespace"></span> This will allow us to design the look and feel of the web pages first, deferring the back-end functionality until later in this section.</p>
<p>When we last left the sample data populator in <a href="http://www.railstutorial.org/book/user_microposts#code-sample_microposts" class="hyperref">Listing&nbsp;<span class="ref">10.20</span></a>, it was getting rather cluttered, so we begin by defining separate methods to make users and microposts, and then add sample relationship data using a new <code>make_relationships</code> method.<span class="intersentencespace"></span> The results are shown in <a href="http://www.railstutorial.org/book/following_users#code-sample_relationships" class="hyperref">Listing&nbsp;<span class="ref">11.17</span></a>.</p>
<div class="codelisting" id="_code-sample_relationships" data-tralics-id="uid904" data-number="11.17"><div class="heading"><span class="number">Listing 11.17:</span> 

<span class="description">Adding following/follower relationships to the sample data.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">lib/tasks/sample_data.rake</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">"Fill database with sample data"</span>
  <span class="n">task</span> <span class="ss">populate</span><span class="p">:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="n">make_users</span>
    <span class="n">make_microposts</span>
    <span class="n">make_relationships</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">make_users</span>
  <span class="n">admin</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>     <span class="s2">"Example User"</span><span class="p">,</span>
                       <span class="ss">email</span><span class="p">:</span>    <span class="s2">"example@railstutorial.org"</span><span class="p">,</span>
                       <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span>
                       <span class="n">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span>
                       <span class="ss">admin</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
  <span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
    <span class="nb">name</span>  <span class="o">=</span> <span class="ss">Faker</span><span class="p">:</span><span class="ss">:Name</span><span class="o">.</span><span class="n">name</span>
    <span class="n">email</span> <span class="o">=</span> <span class="s2">"example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org"</span>
    <span class="n">password</span>  <span class="o">=</span> <span class="s2">"password"</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>     <span class="nb">name</span><span class="p">,</span>
                 <span class="ss">email</span><span class="p">:</span>    <span class="n">email</span><span class="p">,</span>
                 <span class="ss">password</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
                 <span class="n">password_confirmation</span><span class="p">:</span> <span class="n">password</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">make_microposts</span>
  <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">limit</span><span class="p">:</span> <span class="mi">6</span><span class="p">)</span>
  <span class="mi">50</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
    <span class="n">content</span> <span class="o">=</span> <span class="ss">Faker</span><span class="p">:</span><span class="ss">:Lorem</span><span class="o">.</span><span class="n">sentence</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="n">content</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">make_relationships</span>
  <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="n">user</span>  <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">first</span>
  <span class="n">followed_users</span> <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="mi">50</span><span class="o">]</span>
  <span class="n">followers</span>      <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="mi">40</span><span class="o">]</span>
  <span class="n">followed_users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">followed</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">followers</span><span class="o">.</span><span class="n">each</span>      <span class="p">{</span> <span class="o">|</span><span class="n">follower</span><span class="o">|</span> <span class="n">follower</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div></div><p>Here the sample relationships are created using the code</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">make_relationships</span>
  <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="n">user</span>  <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">first</span>
  <span class="n">followed_users</span> <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="mi">50</span><span class="o">]</span>
  <span class="n">followers</span>      <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="mi">40</span><span class="o">]</span>
  <span class="n">followed_users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">followed</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">followers</span><span class="o">.</span><span class="n">each</span>      <span class="p">{</span> <span class="o">|</span><span class="n">follower</span><span class="o">|</span> <span class="n">follower</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>
<p>We somewhat arbitrarily arrange for the first user to follow users&nbsp;3 through 51, and then have users 4 through 41 follow that user back.<span class="intersentencespace"></span> The resulting relationships will be sufficient for developing the application interface.</p>
<p>To execute the code in <a href="http://www.railstutorial.org/book/following_users#code-sample_relationships" class="hyperref">Listing&nbsp;<span class="ref">11.17</span></a>, populate the database as usual:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div></div>
</div>
<div id="_sec-stats_and_a_follow_form" data-tralics-id="uid905" class="subsection" data-number="11.2.2"><h3><a href="http://www.railstutorial.org/book/following_users#sec-stats_and_a_follow_form" class="heading hyperref"><span class="number">11.2.2 </span>Stats and a follow form</a></h3>
<p>Now that our sample users have both followed user and followers arrays, we need to update the profile page and Home page to reflect this.<span class="intersentencespace"></span> We’ll start by making a partial to display the following and follower statistics on the profile and home pages.<span class="intersentencespace"></span> We’ll next add a follow/unfollow form, and then make dedicated pages for showing user followed users and followers.</p>
<p>As noted in <a href="http://www.railstutorial.org/book/following_users#sec-a_problem_with_the_data_model" class="hyperref">Section&nbsp;<span class="ref">11.1.1</span></a>, while the word “following” is ambiguous as an attribute (where <code>user.following</code> could reasonably mean either the followed users or the user’s followers), it makes sense as a label, as in “50 following”.<span class="intersentencespace"></span> Indeed, this is the label used by Twitter itself, a usage adopted in the mockups starting in <a href="http://www.railstutorial.org/book/following_users#fig-page_flow_profile_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.1</span></a> and shown in close-up in <a href="http://www.railstutorial.org/book/following_users#fig-stats_partial_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.10</span></a>.</p>
<div class="center figure" id="_fig-stats_partial_mockup" data-tralics-id="uid906" data-number="11.10"><span class="graphics"><img src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/stats_partial_mockup.png" alt="stats_partial_mockup"></span>
<div class="caption"><span class="header">Figure 11.10: </span><span class="description">A mockup of the stats partial.
</span></div></div>
<p>The stats in <a href="http://www.railstutorial.org/book/following_users#fig-stats_partial_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.10</span></a> consist of the number of users the current user is following and the number of followers, each of which should be a link to its respective dedicated display page.<span class="intersentencespace"></span> In <a href="http://www.railstutorial.org/book/filling_in_the_layout#cha-filling_in_the_layout" class="hyperref">Chapter&nbsp;<span class="ref">5</span></a>, we stubbed out such links with the dummy text&nbsp;<code>’#’</code>, but that was before we had much experience with routes.<span class="intersentencespace"></span> This time, although we’ll defer the actual pages to <a href="http://www.railstutorial.org/book/following_users#sec-following_and_followers_pages" class="hyperref">Section&nbsp;<span class="ref">11.2.3</span></a>, we’ll make the routes now, as seen in <a href="http://www.railstutorial.org/book/following_users#code-following_followers_actions_routes" class="hyperref">Listing&nbsp;<span class="ref">11.18</span></a>.<span class="intersentencespace"></span> This code uses the <code>:member</code> method inside a <code>resources</code> <em>block</em>, which we haven’t seen before, but see if you can guess what it does.<span class="intersentencespace"></span> (<em>Note</em>: The code in <a href="http://www.railstutorial.org/book/following_users#code-following_followers_actions_routes" class="hyperref">Listing&nbsp;<span class="ref">11.18</span></a> should <em>replace</em> the <code>resources :users</code>.)</p>
<div class="codelisting" id="_code-following_followers_actions_routes" data-tralics-id="uid907" data-number="11.18"><div class="heading"><span class="number">Listing 11.18:</span> 

<span class="description">Adding <code>following</code> and <code>followers</code> actions to the Users controller.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="ss">SampleApp</span><span class="p">:</span><span class="ss">:Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
    <span class="n">member</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:followers</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>You might suspect that the URLs will look like /users/1/following and /users/1/followers, and that is exactly what the code in <a href="http://www.railstutorial.org/book/following_users#code-following_followers_actions_routes" class="hyperref">Listing&nbsp;<span class="ref">11.18</span></a> does.<span class="intersentencespace"></span> Since both pages will be showing data, we use <code>get</code> to arrange for the URLs to respond to <span class="tt">GET</span> requests (as required by the REST convention for such pages), and the <code>member</code> method means that the routes respond to URLs containing the user id.<span class="intersentencespace"></span> The other possibility, <code>collection</code>, works without the id, so that</p>
<div class="code"><div class="highlight"><pre><span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">collection</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:tigers</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>would respond to the URL /users/tigers (presumably to display all the tigers in our application).<span class="intersentencespace"></span> For more details on such routing options, see the <a href="http://guides.rubyonrails.org/routing.html">Rails Guides article on “Rails Routing from the Outside In”</a>.<span class="intersentencespace"></span> A table of the routes generated by <a href="http://www.railstutorial.org/book/following_users#code-following_followers_actions_routes" class="hyperref">Listing&nbsp;<span class="ref">11.18</span></a> appears in <a href="http://www.railstutorial.org/book/following_users#table-following_routes" class="hyperref">Table&nbsp;<span class="ref">11.13</span></a>; note the named routes for the followed user and followers pages, which we’ll put to use shortly.<span class="intersentencespace"></span> The unfortunate hybrid usage in the “following” route is forced by our choice to use the unambiguous “followed users” terminology along with the “following” usage from Twitter.<span class="intersentencespace"></span> Since the former would lead to routes of the form <code>followed_users_user_path</code>, which sounds strange, we’ve opted for the latter in the context of <a href="http://www.railstutorial.org/book/following_users#table-following_routes" class="hyperref">Table&nbsp;<span class="ref">11.13</span></a>, yielding <code>following_user_path</code>.</p>
<div class="table" id="_table-following_routes" data-tralics-id="uid908" data-number="11.13"><table class="tabular"><tbody><tr class="bottom_border"><td class="align_left"><strong>HTTP request</strong></td>
<td class="align_left"><strong>URL</strong></td>
<td class="align_left"><strong>Action</strong></td>
<td class="align_left"><strong>Named route</strong></td>
</tr><tr><td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/users/1/following</td>
<td class="align_left"><code>following</code></td>
<td class="align_left"><code>following_user_path(1)</code></td>
</tr><tr><td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/users/1/followers</td>
<td class="align_left"><code>followers</code></td>
<td class="align_left"><code>followers_user_path(1)</code></td>
</tr></tbody></table><div class="caption"><span class="header">Table 11.13: </span><span class="description">RESTful routes provided by the custom rules in resource in <a href="http://www.railstutorial.org/book/following_users#code-following_followers_actions_routes" class="hyperref">Listing&nbsp;<span class="ref">11.18</span></a>.
</span></div></div>
<p>With the routes defined, we are now in a position to make tests for the stats partial.<span class="intersentencespace"></span> (We could have written the tests first, but the named routes would have been hard to motivate without the updated routes file.)<span class="intersentencespace"></span> The stats partial will appear on both the profile page and the Home page; <a href="http://www.railstutorial.org/book/following_users#code-stats_view_test" class="hyperref">Listing&nbsp;<span class="ref">11.19</span></a> opts to test it on the latter.</p>
<div class="codelisting" id="_code-stats_view_test" data-tralics-id="uid909" data-number="11.19"><div class="heading"><span class="number">Listing 11.19:</span> 

<span class="description">Testing the following/follower statistics on the Home page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/static_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"for signed-in users"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem"</span><span class="p">)</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content</span><span class="p">:</span> <span class="s2">"Ipsum"</span><span class="p">)</span>
        <span class="n">sign_in</span> <span class="n">user</span>
        <span class="n">visit</span> <span class="n">root_path</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"should render the user's feed"</span> <span class="k">do</span>
        <span class="n">user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
          <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">"li#</span><span class="si">#{</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">"follower/following counts"</span> <span class="k">do</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">other_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
          <span class="n">visit</span> <span class="n">root_path</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s2">"0 following"</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">following_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s2">"1 followers"</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The core of this test is the expectation that the following and follower counts appear on the page, together with the right URLs:</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s2">"0 following"</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">following_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s2">"1 followers"</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
</pre></div></div>
<p>Here we have used the named routes shown in <a href="http://www.railstutorial.org/book/following_users#table-following_routes" class="hyperref">Table&nbsp;<span class="ref">11.13</span></a> to verify that the links have the right addresses.<span class="intersentencespace"></span> Also note that in this case the word “followers” is acting as a <em>label</em>, so we keep it plural even when there is only one follower.</p>
<p>The application code for the stats partial is just a couple of links inside a div, as shown in <a href="http://www.railstutorial.org/book/following_users#code-stats_partial" class="hyperref">Listing&nbsp;<span class="ref">11.20</span></a>.</p>
<div class="codelisting" id="_code-stats_partial" data-tralics-id="uid910" data-number="11.20"><div class="heading"><span class="number">Listing 11.20:</span> 

<span class="description">A partial for displaying follower stats.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/shared/_stats.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="vi">@user</span> <span class="o">||=</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"stats"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">following_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">"following"</span> <span class="na">class=</span><span class="s">"stat"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followed_users</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/strong&gt;</span>
    following
  <span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">"followers"</span> <span class="na">class=</span><span class="s">"stat"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/strong&gt;</span>
    followers
  <span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><p>Since we will be including the stats on both the user show pages and the home page, the first line of <a href="http://www.railstutorial.org/book/following_users#code-stats_partial" class="hyperref">Listing&nbsp;<span class="ref">11.20</span></a> picks the right one using</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="vi">@user</span> <span class="o">||=</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>As discussed in <a href="http://www.railstutorial.org/book/sign_in_out#sidebar-or_equals" class="hyperref">Box&nbsp;<span class="ref">8.2</span></a>, this does nothing when <code>@user</code> is not <code>nil</code> (as on a profile page), but when it is (as on the Home page) it sets <code>@user</code> to the current user.</p>
<p>Note also that the following/follower counts are calculated through the associations using</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">followed_users</span><span class="o">.</span><span class="n">count</span>
</pre></div></div>
<p>and</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">count</span>
</pre></div></div>
<p>Compare these to the microposts count from <a href="http://www.railstutorial.org/book/user_microposts#code-user_show_microposts" class="hyperref">Listing&nbsp;<span class="ref">10.17</span></a>, where we wrote</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span>
</pre></div></div>
<p>to count the microposts.</p>
<p>One final detail worth noting is the presence of CSS ids on some elements, as in</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">"following"</span> <span class="na">class=</span><span class="s">"stat"</span><span class="nt">&gt;</span>
...
<span class="nt">&lt;/strong&gt;</span>
</pre></div></div>
<p>This is for the benefit of the Ajax implementation in <a href="http://www.railstutorial.org/book/following_users#sec-a_working_follow_button_with_ajax" class="hyperref">Section&nbsp;<span class="ref">11.2.5</span></a>, which accesses elements on the page using their unique ids.</p>
<p>With the partial in hand, including the stats on the Home page is easy, as shown in <a href="http://www.railstutorial.org/book/following_users#code-home_page_stats" class="hyperref">Listing&nbsp;<span class="ref">11.21</span></a>.<span class="intersentencespace"></span> (This also gets the test in <a href="http://www.railstutorial.org/book/following_users#code-stats_view_test" class="hyperref">Listing&nbsp;<span class="ref">11.19</span></a> to pass.)</p>
<div class="codelisting" id="_code-home_page_stats" data-tralics-id="uid911" data-number="11.21"><div class="heading"><span class="number">Listing 11.21:</span> 

<span class="description">Adding follower stats to the Home page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
      .
      .
      .
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/user_info'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/stats'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/micropost_form'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      .
      .
      .
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>To style the stats, we’ll add some SCSS, as shown in <a href="http://www.railstutorial.org/book/following_users#code-stats_css" class="hyperref">Listing&nbsp;<span class="ref">11.22</span></a> (which contains all the stylesheet code needed in this chapter).<span class="intersentencespace"></span> The result appears in <a href="http://www.railstutorial.org/book/following_users#fig-home_page_follow_stats" class="hyperref">Figure&nbsp;<span class="ref">11.11</span></a>.</p>
<div class="codelisting" id="_code-stats_css" data-tralics-id="uid912" data-number="11.22"><div class="heading"><span class="number">Listing 11.22:</span> 

<span class="description">SCSS for the Home page sidebar.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">sidebar</span> <span class="o">*/</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.stats</span> <span class="p">{</span>
  <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
  <span class="nt">a</span> <span class="p">{</span>
    <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">0</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="na">border-left</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="na">color</span><span class="o">:</span> <span class="nb">gray</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:first-child</span> <span class="p">{</span>
      <span class="na">padding-left</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="na">border</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span>
      <span class="na">text-decoration</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
      <span class="na">color</span><span class="o">:</span> <span class="nv">$blue</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nt">strong</span> <span class="p">{</span>
    <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nc">.user_avatars</span> <span class="p">{</span>
  <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="nc">.gravatar</span> <span class="p">{</span>
    <span class="na">margin</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="mi">1</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
</pre></div></div></div><div class="center figure" id="_fig-home_page_follow_stats" data-tralics-id="uid913" data-number="11.11">
<div class="graphics image box"><img src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/home_page_follow_stats_bootstrap.png" alt="images/figures/home_page_follow_stats_bootstrap"></div><div class="caption"><span class="header">Figure 11.11: </span><span class="description">The Home page (<a href="http://localhost:3000/">/</a>) with follow stats.
</span></div></div>
<p>We’ll render the stats partial on the profile page in a moment, but first let’s make a partial for the follow/unfollow button, as shown in <a href="http://www.railstutorial.org/book/following_users#code-follow_form_partial" class="hyperref">Listing&nbsp;<span class="ref">11.23</span></a>.</p>
<div class="codelisting" id="_code-follow_form_partial" data-tralics-id="uid914" data-number="11.23"><div class="heading"><span class="number">Listing 11.23:</span> 

<span class="description">A partial for a follow/unfollow form.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_follow_form.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"follow_form"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'unfollow'</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'follow'</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>This does nothing but defer the real work to <code>follow</code> and <code>unfollow</code> partials, which need a new routes file with rules for the Relationships resource, which follows the Microposts resource example (<a href="http://www.railstutorial.org/book/user_microposts#code-microposts_resource" class="hyperref">Listing&nbsp;<span class="ref">10.22</span></a>), as seen in <a href="http://www.railstutorial.org/book/following_users#code-relationships_resource" class="hyperref">Listing&nbsp;<span class="ref">11.24</span></a>.</p>
<div class="codelisting" id="_code-relationships_resource" data-tralics-id="uid915" data-number="11.24"><div class="heading"><span class="number">Listing 11.24:</span> 

<span class="description">Adding the routes for user relationships.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="ss">SampleApp</span><span class="p">:</span><span class="ss">:Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span>      <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span>    <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The follow/unfollow partials themselves are shown in <a href="http://www.railstutorial.org/book/following_users#code-follow_form" class="hyperref">Listing&nbsp;<span class="ref">11.25</span></a> and <a href="http://www.railstutorial.org/book/following_users#code-unfollow_form" class="hyperref">Listing&nbsp;<span class="ref">11.26</span></a>.</p>
<div class="codelisting" id="_code-follow_form" data-tralics-id="uid916" data-number="11.25"><div class="heading"><span class="number">Listing 11.25:</span> 

<span class="description">A form for following a user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_follow.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">followed_id</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">))</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">hidden_field</span> <span class="ss">:followed_id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Follow"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><div class="codelisting" id="_code-unfollow_form" data-tralics-id="uid917" data-number="11.26"><div class="heading"><span class="number">Listing 11.26:</span> 

<span class="description">A form for unfollowing a user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_unfollow.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="n">followed_id</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
             <span class="ss">html</span><span class="p">:</span> <span class="p">{</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Unfollow"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>These two forms both use <code>form_for</code> to manipulate a Relationship model object; the main difference between the two is that <a href="http://www.railstutorial.org/book/following_users#code-follow_form" class="hyperref">Listing&nbsp;<span class="ref">11.25</span></a> builds a <em>new</em> relationship, whereas <a href="http://www.railstutorial.org/book/following_users#code-unfollow_form" class="hyperref">Listing&nbsp;<span class="ref">11.26</span></a> finds the existing relationship.<span class="intersentencespace"></span> Naturally, the former sends a <span class="tt">POST</span> request to the Relationships controller to <code>create</code> a relationship, while the latter sends a <span class="tt">DELETE</span> request to <code>destroy</code> a relationship.<span class="intersentencespace"></span> (We’ll write these actions in <a href="http://www.railstutorial.org/book/following_users#sec-a_working_follow_button_the_standard_way" class="hyperref">Section&nbsp;<span class="ref">11.2.4</span></a>.)<span class="intersentencespace"></span> Finally, you’ll note that the follow form doesn’t have any content other than the button, but it still needs to send the <code>followed_id</code> to the controller.<span class="intersentencespace"></span> We accomplish this with the <code>hidden_field</code> method in <a href="http://www.railstutorial.org/book/following_users#code-follow_form" class="hyperref">Listing&nbsp;<span class="ref">11.25</span></a>, which produces HTML of the form</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"relationship_followed_id"</span>
<span class="na">name=</span><span class="s">"relationship[followed_id]"</span>
<span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"3"</span> <span class="nt">/&gt;</span>
</pre></div></div>
<p>The “hidden” <code>input</code> tag puts the relevant information on the page without displaying it in the browser.</p>
<p>We can now include the follow form and the following statistics on the user profile page simply by rendering the partials, as shown in <a href="http://www.railstutorial.org/book/following_users#code-user_follow_form_profile_stats" class="hyperref">Listing&nbsp;<span class="ref">11.27</span></a>.<span class="intersentencespace"></span> Profiles with follow and unfollow buttons, respectively, appear in <a href="http://www.railstutorial.org/book/following_users#fig-profile_follow_button" class="hyperref">Figure&nbsp;<span class="ref">11.12</span></a> and <a href="http://www.railstutorial.org/book/following_users#fig-profile_unfollow_button" class="hyperref">Figure&nbsp;<span class="ref">11.13</span></a>.</p>
<div class="codelisting" id="_code-user_follow_form_profile_stats" data-tralics-id="uid918" data-number="11.27"><div class="heading"><span class="number">Listing 11.27:</span> 

<span class="description">Adding the follow form and follower stats to the user profile page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/show.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"span4"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="nt">&lt;h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/stats'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span8"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'follow_form'</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
    .
    .
    .
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><div class="center figure" id="_fig-profile_follow_button" data-tralics-id="uid919" data-number="11.12">
<div class="graphics image box"><img src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/profile_follow_button_bootstrap.png" alt="images/figures/profile_follow_button_bootstrap"></div><div class="caption"><span class="header">Figure 11.12: </span><span class="description">A user profile with a follow button (<a href="http://localhost:3000/users/2">/users/2</a>).
</span></div></div>
<div class="center figure" id="_fig-profile_unfollow_button" data-tralics-id="uid920" data-number="11.13">
<div class="graphics image box"><img src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/profile_unfollow_button_bootstrap.png" alt="images/figures/profile_unfollow_button_bootstrap"></div><div class="caption"><span class="header">Figure 11.13: </span><span class="description">A user profile with an unfollow button (<a href="http://localhost:3000/users/8">/users/6</a>).
</span></div></div>
<p>We’ll get these buttons working soon enough—in fact, we’ll do it two ways, the standard way (<a href="http://www.railstutorial.org/book/following_users#sec-a_working_follow_button_the_standard_way" class="hyperref">Section&nbsp;<span class="ref">11.2.4</span></a>) and using Ajax (<a href="http://www.railstutorial.org/book/following_users#sec-a_working_follow_button_with_ajax" class="hyperref">Section&nbsp;<span class="ref">11.2.5</span></a>)—but first we’ll finish the HTML interface by making the following and followers pages.</p>
</div>
<div id="_sec-following_and_followers_pages" data-tralics-id="uid921" class="subsection" data-number="11.2.3"><h3><a href="http://www.railstutorial.org/book/following_users#sec-following_and_followers_pages" class="heading hyperref"><span class="number">11.2.3 </span>Following and followers pages</a></h3>
<p>Pages to display followed users and followers will resemble a hybrid of the user profile page and the user index page (<a href="http://www.railstutorial.org/book/updating_and_deleting_users#sec-user_index" class="hyperref">Section&nbsp;<span class="ref">9.3.1</span></a>), with a sidebar of user information (including the following stats) and a list of users.<span class="intersentencespace"></span> In addition, we’ll include a raster of user profile image links in the sidebar.<span class="intersentencespace"></span> Mockups matching these requirements appear in <a href="http://www.railstutorial.org/book/following_users#fig-following_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.14</span></a> (following) and <a href="http://www.railstutorial.org/book/following_users#fig-followers_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.15</span></a> (followers).</p>
<div class="center figure" id="_fig-following_mockup" data-tralics-id="uid922" data-number="11.14">
<div class="graphics image box"><img src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/following_mockup_bootstrap.png" alt="images/figures/following_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 11.14: </span><span class="description">A mockup of the user following page.
</span></div></div>
<div class="center figure" id="_fig-followers_mockup" data-tralics-id="uid923" data-number="11.15">
<div class="graphics image box"><img src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/followers_mockup_bootstrap.png" alt="images/figures/followers_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 11.15: </span><span class="description">A mockup of the user followers page.
</span></div></div>
<p>Our first step is to get the following and followers links to work.<span class="intersentencespace"></span> We’ll follow Twitter’s lead and have both pages require user signin, as tested in <a href="http://www.railstutorial.org/book/following_users#code-following_followers_authorization_test" class="hyperref">Listing&nbsp;<span class="ref">11.28</span></a>.<span class="intersentencespace"></span> For signed-in users, the pages should have links for following and followers, respectively, as tested in <a href="http://www.railstutorial.org/book/following_users#code-following_followers_tests" class="hyperref">Listing&nbsp;<span class="ref">11.29</span></a>.</p>
<div class="codelisting" id="_code-following_followers_authorization_test" data-tralics-id="uid924" data-number="11.28"><div class="heading"><span class="number">Listing 11.28:</span> 

<span class="description">Tests for the authorization of the following and followers pages.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"for non-signed-in users"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"in the Users controller"</span> <span class="k">do</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="n">describe</span> <span class="s2">"visiting the following page"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">following_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">"visiting the followers page"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-following_followers_tests" data-tralics-id="uid925" data-number="11.29"><div class="heading"><span class="number">Listing 11.29:</span> 

<span class="description">Test for the <code>followed_users</code> and <code>followers</code> pages.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"following/followers"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"followed users"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">sign_in</span> <span class="n">user</span>
        <span class="n">visit</span> <span class="n">following_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'Following'</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'h3'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'Following'</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">other_user</span><span class="p">))</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">"followers"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">sign_in</span> <span class="n">other_user</span>
        <span class="n">visit</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'Followers'</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'h3'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'Followers'</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The only tricky part of the implementation is realizing that we need to add two new actions to the Users controller; based on the routes defined in <a href="http://www.railstutorial.org/book/following_users#code-following_followers_actions_routes" class="hyperref">Listing&nbsp;<span class="ref">11.18</span></a>, we need to call them <code>following</code> and <code>followers</code>.<span class="intersentencespace"></span> Each action needs to set a title, find the user, retrieve either <code>@user.followed_users</code> or <code>@user.followers</code> (in paginated form), and then render the page.<span class="intersentencespace"></span> The result appears in <a href="http://www.railstutorial.org/book/following_users#code-following_followers_actions" class="hyperref">Listing&nbsp;<span class="ref">11.30</span></a>.</p>
<div class="codelisting" id="_code-following_followers_actions" data-tralics-id="uid926" data-number="11.30"><div class="heading"><span class="number">Listing 11.30:</span> 

<span class="description">The <code>following</code> and <code>followers</code> actions.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span>
                <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:followers</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">following</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">"Following"</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followed_users</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="n">render</span> <span class="s1">'show_follow'</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">followers</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">"Followers"</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="n">render</span> <span class="s1">'show_follow'</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Note here that both actions make an <em>explicit</em> call to <code>render</code>, in this case rendering a view called <code>show_follow</code>, which we must create.<span class="intersentencespace"></span> The reason for the common view is that the ERb is nearly identical for the two cases, and <a href="http://www.railstutorial.org/book/following_users#code-show_follow_view" class="hyperref">Listing&nbsp;<span class="ref">11.31</span></a> covers them both.</p>
<div class="codelisting" id="_code-show_follow_view" data-tralics-id="uid927" data-number="11.31"><div class="heading"><span class="number">Listing 11.31:</span> 

<span class="description">The <code>show_follow</code> view used to render following and followers.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/show_follow.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@title</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"span4"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
      <span class="nt">&lt;span&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"view my profile"</span><span class="p">,</span> <span class="vi">@user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;span&gt;&lt;b&gt;</span>Microposts:<span class="nt">&lt;/b&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/stats'</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@users</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"user_avatars"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">30</span><span class="p">),</span> <span class="n">user</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h3&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@users</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><p>With that, the tests should now be passing, and the pages should render as shown in <a href="http://www.railstutorial.org/book/following_users#fig-user_following" class="hyperref">Figure&nbsp;<span class="ref">11.16</span></a> (following) and <a href="http://www.railstutorial.org/book/following_users#fig-user_followers" class="hyperref">Figure&nbsp;<span class="ref">11.17</span></a> (followers).</p>
<div class="center figure" id="_fig-user_following" data-tralics-id="uid928" data-number="11.16">
<div class="graphics image box"><img src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/user_following_bootstrap.png" alt="images/figures/user_following_bootstrap"></div><div class="caption"><span class="header">Figure 11.16: </span><span class="description">Showing the users being followed by the current user.
</span></div></div>
<div class="center figure" id="_fig-user_followers" data-tralics-id="uid929" data-number="11.17">
<div class="graphics image box"><img src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/user_followers_bootstrap.png" alt="images/figures/user_followers_bootstrap"></div><div class="caption"><span class="header">Figure 11.17: </span><span class="description">Showing the current user’s followers.
</span></div></div>
</div>
<div id="_sec-a_working_follow_button_the_standard_way" data-tralics-id="uid930" class="subsection" data-number="11.2.4"><h3><a href="http://www.railstutorial.org/book/following_users#sec-a_working_follow_button_the_standard_way" class="heading hyperref"><span class="number">11.2.4 </span>A working follow button the standard way</a></h3>
<p>Now that our views are in order, it’s time to get the follow/unfollow buttons working.<span class="intersentencespace"></span> The tests for these buttons combine many of the testing techniques covered throughout this tutorial and make for a good exercise in reading code.<span class="intersentencespace"></span> Study <a href="http://www.railstutorial.org/book/following_users#code-follow_unfollow_button_tests" class="hyperref">Listing&nbsp;<span class="ref">11.32</span></a> until you are convinced that you understand what it’s testing and why.<span class="intersentencespace"></span> (There’s one minor security omission in <a href="http://www.railstutorial.org/book/following_users#code-follow_unfollow_button_tests" class="hyperref">Listing&nbsp;<span class="ref">11.32</span></a>; see if you can spot it.<span class="intersentencespace"></span> We’ll cover it momentarily.)<span class="intersentencespace"></span> Note in particular the use of the <code>have_xpath</code> method, which is an advanced and powerful technique that uses <a href="http://en.wikipedia.org/wiki/XPath">XPath</a> to navigate XML documents (including HTML5).<span class="intersentencespace"></span> You can read more about XPath by doing a web search for <a href="http://www.w3schools.com/xpath/xpath_syntax.asp">XPath syntax</a>.</p>
<div class="codelisting" id="_code-follow_unfollow_button_tests" data-tralics-id="uid931" data-number="11.32"><div class="heading"><span class="number">Listing 11.32:</span> 

<span class="description">Tests for the Follow/Unfollow button.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"profile page"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"follow/unfollow buttons"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"following a user"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

        <span class="n">it</span> <span class="s2">"should increment the followed user count"</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_button</span> <span class="s2">"Follow"</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">followed_users</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">"should increment the other user's followers count"</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_button</span> <span class="s2">"Follow"</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">followers</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">"toggling the button"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Follow"</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_xpath</span><span class="p">(</span><span class="s2">"//input[@value='Unfollow']"</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">"unfollowing a user"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
          <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">"should decrement the followed user count"</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_button</span> <span class="s2">"Unfollow"</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">followed_users</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">"should decrement the other user's followers count"</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_button</span> <span class="s2">"Unfollow"</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">followers</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">"toggling the button"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Unfollow"</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_xpath</span><span class="p">(</span><span class="s2">"//input[@value='Follow']"</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p><a href="http://www.railstutorial.org/book/following_users#code-follow_unfollow_button_tests" class="hyperref">Listing&nbsp;<span class="ref">11.32</span></a> tests the following buttons by clicking on them and specifying the proper behavior.<span class="intersentencespace"></span> Writing the implementation involves digging a little deeper: following and unfollowing involve <em>creating</em> and <em>destroying</em> relationships, which means defining <code>create</code> and <code>destroy</code> actions in a Relationships controller (which we must create).<span class="intersentencespace"></span> Although the following buttons only appear for signed-in users, giving us a superficial layer of security, the tests in <a href="http://www.railstutorial.org/book/following_users#code-follow_unfollow_button_tests" class="hyperref">Listing&nbsp;<span class="ref">11.32</span></a> miss a lower-level issue, namely, the <code>create</code> and <code>destroy</code> actions themselves should only be accessible to signed-in users.<span class="intersentencespace"></span> (This is the security hole alluded to above.)<span class="intersentencespace"></span> <a href="http://www.railstutorial.org/book/following_users#code-relationships_controller_authorization_test" class="hyperref">Listing&nbsp;<span class="ref">11.33</span></a> expresses this requirement using the <code>post</code> and <code>delete</code> methods to hit those actions directly.</p>
<div class="codelisting" id="_code-relationships_controller_authorization_test" data-tralics-id="uid932" data-number="11.33"><div class="heading"><span class="number">Listing 11.33:</span> 

<span class="description">Tests for the Relationships controller authorization.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"for non-signed-in users"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">"in the Relationships controller"</span> <span class="k">do</span>
        <span class="n">describe</span> <span class="s2">"submitting to the create action"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">post</span> <span class="n">relationships_path</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">"submitting to the destroy action"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that, in order to avoid the overhead of creating a virtually useless Relationship object, the <code>delete</code> test hard-codes the id&nbsp;<code>1</code> in the named route:</p>
<div class="code"><div class="highlight"><pre><span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>
<p>This works because the user should be redirected before the application ever tries to retrieve the relationship with this&nbsp;id.</p>
<p>The controller code needed to get these tests to pass is remarkably concise: we just retrieve the user followed or to be followed, and then follow or unfollow the user using the relevant utility method.<span class="intersentencespace"></span> The full implementation appears in <a href="http://www.railstutorial.org/book/following_users#code-relationships_controller" class="hyperref">Listing&nbsp;<span class="ref">11.34</span></a>.</p>
<div class="codelisting" id="_code-relationships_controller" data-tralics-id="uid933" data-number="11.34"><div class="heading"><span class="number">Listing 11.34:</span> 

<span class="description">The Relationships controller.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/relationships_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:relationship</span><span class="o">][</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">redirect_to</span> <span class="vi">@user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">redirect_to</span> <span class="vi">@user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>We can see from <a href="http://www.railstutorial.org/book/following_users#code-relationships_controller" class="hyperref">Listing&nbsp;<span class="ref">11.34</span></a> why the security issue mentioned above is minor: if an unsigned-in user were to hit either action directly (e.g., using a command-line tool like <span class="tt">curl</span>), <code>current_user</code> would be <code>nil</code>, and in both cases the action’s second line would raise an exception, resulting in an error but no harm to the application or its data.<span class="intersentencespace"></span> It’s best not to rely on that, though, so we’ve taken the extra step and added an extra layer of security.</p>
<p>With that, the core follow/unfollow functionality is complete, and any user can follow (or unfollow) any other user, which you should verify both by clicking around in the sample application and by running the test suite:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div>
<div id="_sec-a_working_follow_button_with_ajax" data-tralics-id="uid934" class="subsection" data-number="11.2.5"><h3><a href="http://www.railstutorial.org/book/following_users#sec-a_working_follow_button_with_ajax" class="heading hyperref"><span class="number">11.2.5 </span>A working follow button with Ajax</a></h3>
<p>Although our user following implementation is complete as it stands, we have one bit of polish left to add before starting work on the status feed.<span class="intersentencespace"></span> You may have noticed in <a href="http://www.railstutorial.org/book/following_users#sec-a_working_follow_button_the_standard_way" class="hyperref">Section&nbsp;<span class="ref">11.2.4</span></a> that both the <code>create</code> and <code>destroy</code> actions in the Relationships controller simply redirect <em>back</em> to the original profile.<span class="intersentencespace"></span> In other words, a user starts on a profile page, follows the user, and is immediately redirected back to the original page.<span class="intersentencespace"></span> It is reasonable to ask why the user needs to leave that page at all.</p>
<p>This is exactly the problem solved by <em>Ajax</em>, which allows web pages to send requests asynchronously to the server without leaving the page.<sup id="_cha-11_footnote-ref-8" class="footnote intersentence"><a href="http://www.railstutorial.org/book/following_users#cha-11_footnote-8">8</a></sup><span class="intersentencespace"></span> Because the practice of adding Ajax to web forms is quite common, Rails makes Ajax easy to implement.<span class="intersentencespace"></span> Indeed, updating the follow/unfollow form partials is trivial: just change</p>
<div class="code"><div class="highlight"><pre><span class="n">form_for</span>
</pre></div></div>
<p>to</p>
<div class="code"><div class="highlight"><pre><span class="n">form_for</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">,</span> <span class="ss">remote</span><span class="p">:</span> <span class="kp">true</span>
</pre></div></div>
<p>and Rails <a href="http://catb.org/jargon/html/A/automagically.html">automagically</a> uses Ajax.<sup id="_cha-11_footnote-ref-9" class="footnote intersentence"><a href="http://www.railstutorial.org/book/following_users#cha-11_footnote-9">9</a></sup><span class="intersentencespace"></span> The updated partials appear in <a href="http://www.railstutorial.org/book/following_users#code-follow_form_ajax" class="hyperref">Listing&nbsp;<span class="ref">11.35</span></a> and <a href="http://www.railstutorial.org/book/following_users#code-unfollow_form_ajax" class="hyperref">Listing&nbsp;<span class="ref">11.36</span></a>.</p>
<div class="codelisting" id="_code-follow_form_ajax" data-tralics-id="uid937" data-number="11.35"><div class="heading"><span class="number">Listing 11.35:</span> 

<span class="description">A form for following a user using Ajax.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_follow.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">followed_id</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
             <span class="ss">remote</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">hidden_field</span> <span class="ss">:followed_id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Follow"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><div class="codelisting" id="_code-unfollow_form_ajax" data-tralics-id="uid938" data-number="11.36"><div class="heading"><span class="number">Listing 11.36:</span> 

<span class="description">A form for unfollowing a user using Ajax.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_unfollow.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="n">followed_id</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
             <span class="ss">html</span><span class="p">:</span> <span class="p">{</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="p">},</span>
             <span class="ss">remote</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Unfollow"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>The actual HTML generated by this ERb isn’t particularly relevant, but you might be curious, so here’s a peek:</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/relationships/117"</span> <span class="na">class=</span><span class="s">"edit_relationship"</span> <span class="na">data-remote=</span><span class="s">"true"</span>
      <span class="na">id=</span><span class="s">"edit_relationship_117"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  .
  .
  .
<span class="nt">&lt;/form&gt;</span>
</pre></div></div>
<p>This sets the variable <code>data-remote="true"</code> inside the form tag, which tells Rails to allow the form to be handled by JavaScript.<span class="intersentencespace"></span> By using a simple HTML property instead of inserting the full JavaScript code (as in previous versions of Rails), Rails follows the philosophy of <a href="http://railscasts.com/episodes/205-unobtrusive-javascript"><em>unobtrusive JavaScript</em></a>.</p>
<p>Having updated the form, we now need to arrange for the Relationships controller to respond to Ajax requests.<span class="intersentencespace"></span> Testing Ajax is quite tricky, and doing it thoroughly is a large subject in its own right, but we can get started with the code in <a href="http://www.railstutorial.org/book/following_users#code-relationships_controller_spec_ajax" class="hyperref">Listing&nbsp;<span class="ref">11.37</span></a>.<span class="intersentencespace"></span> This uses the <code>xhr</code> method (for “XmlHttpRequest”) to issue an Ajax request; compare to the <code>get</code>, <code>post</code>, <code>patch</code>, and <code>delete</code> methods used in previous tests.<span class="intersentencespace"></span> We then verify that the <code>create</code> and <code>destroy</code> actions do the correct things when hit with an Ajax request.<span class="intersentencespace"></span> (To write more thorough test suites for Ajax-heavy applications, take a look at <a href="http://seleniumhq.org/">Selenium</a> and <a href="http://watir.com/">Watir</a>.)</p>
<div class="codelisting" id="_code-relationships_controller_spec_ajax" data-tralics-id="uid939" data-number="11.37"><div class="heading"><span class="number">Listing 11.37:</span> 

<span class="description">Tests for the Relationships controller responses to Ajax requests.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/controllers/relationships_controller_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">RelationshipsController</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span><span class="p">,</span> <span class="n">no_capybara</span><span class="p">:</span> <span class="kp">true</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"creating a relationship with Ajax"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should increment the Relationship count"</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="k">do</span>
        <span class="n">xhr</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">relationship</span><span class="p">:</span> <span class="p">{</span> <span class="n">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span>
      <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">Relationship</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should respond with success"</span> <span class="k">do</span>
      <span class="n">xhr</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">relationship</span><span class="p">:</span> <span class="p">{</span> <span class="n">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_success</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"destroying a relationship with Ajax"</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:relationship</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="n">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should decrement the Relationship count"</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="k">do</span>
        <span class="n">xhr</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">relationship</span><span class="o">.</span><span class="n">id</span>
      <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">Relationship</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should respond with success"</span> <span class="k">do</span>
      <span class="n">xhr</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">relationship</span><span class="o">.</span><span class="n">id</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_success</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The code in <a href="http://www.railstutorial.org/book/following_users#code-relationships_controller_spec_ajax" class="hyperref">Listing&nbsp;<span class="ref">11.37</span></a> is our first example of a <em>controller</em> test, which I used to use extensively (as in the previous edition of this book) but now mainly eschew in favor of integration tests.<span class="intersentencespace"></span> In this case, though, the <code>xhr</code> method is (somewhat inexplicably) not available in integration tests.<span class="intersentencespace"></span> Although our use of <code>xhr</code> is new, at this point in the tutorial you should be able to infer from context what the code does:</p>
<div class="code"><div class="highlight"><pre><span class="n">xhr</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">relationship</span><span class="p">:</span> <span class="p">{</span> <span class="n">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span>
</pre></div></div>
<p>We see that <code>xhr</code> takes as arguments a symbol for the relevant HTTP method, a symbol for the action, and a hash representing the contents of <code>params</code> in the controller itself.<span class="intersentencespace"></span> As in previous examples, we use <code>expect</code> to wrap the operation in a block and test for an increment or decrement in the relevant count.</p>
<p>As implied by the tests, the application code uses the same <code>create</code> and <code>destroy</code> actions to respond to the Ajax requests that it uses to respond to ordinary <span class="tt">POST</span> and <span class="tt">DELETE</span> HTTP requests.<span class="intersentencespace"></span> All we need to do is respond to a normal HTTP request with a redirect (as in <a href="http://www.railstutorial.org/book/following_users#sec-a_working_follow_button_the_standard_way" class="hyperref">Section&nbsp;<span class="ref">11.2.4</span></a>) and respond to an Ajax request with JavaScript.<span class="intersentencespace"></span> The controller code appears as in <a href="http://www.railstutorial.org/book/following_users#code-relationships_controller_ajax" class="hyperref">Listing&nbsp;<span class="ref">11.38</span></a>.<span class="intersentencespace"></span> (See <a href="http://www.railstutorial.org/book/following_users#sec-following_exercises" class="hyperref">Section&nbsp;<span class="ref">11.5</span></a> for an exercise showing an even more compact way to accomplish the same thing.)</p>
<div class="codelisting" id="_code-relationships_controller_ajax" data-tralics-id="uid940" data-number="11.38"><div class="heading"><span class="number">Listing 11.38:</span> 

<span class="description">Responding to Ajax requests in the Relationships controller.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/relationships_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:relationship</span><span class="o">][</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>This code uses <code>respond_to</code> to take the appropriate action depending on the kind of request.<span class="intersentencespace"></span> (There is no relationship between this <code>respond_to</code> and the <code>respond_to</code> used in the RSpec examples.)<span class="intersentencespace"></span> The syntax is potentially confusing, and it’s important to understand that in</p>
<div class="code"><div class="highlight"><pre><span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
  <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
<span class="k">end</span>
</pre></div></div>
<p>only <em>one</em> of the lines gets executed (based on the nature of the request).</p>
<p>In the case of an Ajax request, Rails automatically calls a <em>JavaScript Embedded Ruby</em> (<code>.js.erb</code>) file with the same name as the action, i.e., <code>create.js.erb</code> or <code>destroy.js.erb</code>.<span class="intersentencespace"></span> As you might guess, the files allow us to mix JavaScript and Embedded Ruby to perform actions on the current page.<span class="intersentencespace"></span> It is these files that we need to create and edit in order to update the user profile page upon being followed or unfollowed.</p>
<p>Inside a JS-ERb file, Rails automatically provides the <a href="http://jquery.com/">jQuery</a> JavaScript helpers to manipulate the page using the <a href="http://www.w3.org/DOM/">Document Object Model (DOM)</a>.<span class="intersentencespace"></span> The jQuery library provides a large number of methods for manipulating the DOM, but here we will need only two.<span class="intersentencespace"></span> First, we will need to know about the dollar-sign syntax to access a DOM element based in its unique CSS&nbsp;id.<span class="intersentencespace"></span> For example, to manipulate the <code>follow_form</code> element, we will use the syntax</p>
<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#follow_form"</span><span class="p">)</span>
</pre></div></div>
<p>(Recall from <a href="http://www.railstutorial.org/book/following_users#code-follow_form_partial" class="hyperref">Listing&nbsp;<span class="ref">11.23</span></a> that this is a <code>div</code> that wraps the form, not the form itself.)<span class="intersentencespace"></span> This syntax, inspired by CSS, uses the&nbsp;<code>#</code> symbol to indicate a CSS&nbsp;id.<span class="intersentencespace"></span> As you might guess, jQuery, like CSS, uses a dot&nbsp;<code>.</code> to manipulate CSS classes.</p>
<p>The second method we’ll need is <code>html</code>, which updates the HTML inside the relevant element with the contents of its argument.<span class="intersentencespace"></span> For example, to replace the entire follow form with the string <code>"foobar"</code>, we would write</p>
<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#follow_form"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>
</pre></div></div>
<p>Unlike plain JavaScript files, JS-ERb files also allow the use of Embedded Ruby, which we apply in the <code>create.js.erb</code> file to update the follow form with the <code>unfollow</code> partial (which is what should show after a successful following) and update the follower count.<span class="intersentencespace"></span> The result is shown in <a href="http://www.railstutorial.org/book/following_users#code-create_js_erb" class="hyperref">Listing&nbsp;<span class="ref">11.39</span></a>.<span class="intersentencespace"></span> This uses the <code>escape_javascript</code> function, which is needed to escape out the result when inserting HTML in a JavaScript file.</p>
<div class="codelisting" id="_code-create_js_erb" data-tralics-id="uid941" data-number="11.39"><div class="heading"><span class="number">Listing 11.39:</span> 

<span class="description">The JavaScript Embedded Ruby to create a following relationship.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/relationships/create.js.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#follow_form"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">"&lt;%= escape_javascript(render('users/unfollow')) %&gt;"</span><span class="p">)</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">"#followers"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">'&lt;%= @user.followers.count %&gt;'</span><span class="p">)</span>
</pre></div></div></div><p>The <code>destroy.js.erb</code> file is analogous (<a href="http://www.railstutorial.org/book/following_users#code-destroy_js_erb" class="hyperref">Listing&nbsp;<span class="ref">11.40</span></a>).</p>
<div class="codelisting" id="_code-destroy_js_erb" data-tralics-id="uid942" data-number="11.40"><div class="heading"><span class="number">Listing 11.40:</span> 

<span class="description">The Ruby JavaScript (RJS) to destroy a following relationship.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/relationships/destroy.js.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#follow_form"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">"&lt;%= escape_javascript(render('users/follow')) %&gt;"</span><span class="p">)</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">"#followers"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">'&lt;%= @user.followers.count %&gt;'</span><span class="p">)</span>
</pre></div></div></div><p>With that, you should navigate to a user profile page and verify that you can follow and unfollow without a page refresh, and the test suite should also pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<p>Using Ajax in Rails is a large and fast-moving subject, so we’ve only been able to scratch the surface here, but (as with the rest of the material in this tutorial) our treatment should give you a good foundation for more advanced resources.</p>
</div></div><div id="_sec-the_status_feed" data-tralics-id="cid68" class="section" data-number="11.3"><h2><a href="http://www.railstutorial.org/book/following_users#sec-the_status_feed" class="heading hyperref"><span class="number">11.3 </span>The status feed</a></h2>
<p>We come now to the pinnacle of our sample application: the status feed.<span class="intersentencespace"></span> Appropriately, this section contains some of the most advanced material in the entire tutorial.<span class="intersentencespace"></span> The full status feed builds on the proto-feed from <a href="http://www.railstutorial.org/book/user_microposts#sec-a_proto_feed" class="hyperref">Section&nbsp;<span class="ref">10.3.3</span></a> by assembling an array of the microposts from the users being followed by the current user, along with the current user’s own microposts.<span class="intersentencespace"></span> To accomplish this feat, we will need some fairly advanced Rails, Ruby, and even SQL programming techniques.</p>
<p>Because of the heavy lifting ahead, it’s especially important to review where we’re going.<span class="intersentencespace"></span> A recap of the final user status feed, shown in <a href="http://www.railstutorial.org/book/following_users#fig-page_flow_home_page_feed_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.5</span></a>, appears again in <a href="http://www.railstutorial.org/book/following_users#fig-home_page_feed_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.18</span></a>.</p>
<div class="center figure" id="_fig-home_page_feed_mockup" data-tralics-id="uid943" data-number="11.18">
<div class="graphics image box"><img src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/page_flow_home_page_feed_mockup_bootstrap.png" alt="images/figures/page_flow_home_page_feed_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 11.18: </span><span class="description">A mockup of a user’s Home page with a status feed.
</span></div></div>
<div id="_sec-motivation_and_strategy" data-tralics-id="uid944" class="subsection" data-number="11.3.1"><h3><a href="http://www.railstutorial.org/book/following_users#sec-motivation_and_strategy" class="heading hyperref"><span class="number">11.3.1 </span>Motivation and strategy</a></h3>
<p>The basic idea behind the feed is simple.<span class="intersentencespace"></span> <a href="http://www.railstutorial.org/book/following_users#fig-user_feed" class="hyperref">Figure&nbsp;<span class="ref">11.19</span></a> shows a sample <code>microposts</code> database table and the resulting feed.<span class="intersentencespace"></span> The purpose of a feed is to pull out the microposts whose user ids correspond to the users being followed by the current user (and the current user itself), as indicated by the arrows in the diagram.</p>
<div class="center figure" id="_fig-user_feed" data-tralics-id="uid945" data-number="11.19">
<div class="graphics image box"><img src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/user_feed.png" alt="images/figures/user_feed"></div><div class="caption"><span class="header">Figure 11.19: </span><span class="description">The feed for a user (id 1) following users 2, 7, 8, and 10.
</span></div></div>
<p>Since we need a way to find all the microposts from users followed by a given user, we’ll plan on implementing a method called <code>from_users_followed_by</code>, which we will use as follows:</p>
<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p>Although we don’t yet know how to implement it, we can already write tests for its functionality.<span class="intersentencespace"></span> The key is to check all three requirements for the feed: microposts for followed users and the user itself should be included in the feed, but a post from an <em>unfollowed</em> user should not be included.<span class="intersentencespace"></span> Two of these requirements already appear in our tests: <a href="http://www.railstutorial.org/book/user_microposts#code-feed_specs" class="hyperref">Listing&nbsp;<span class="ref">10.35</span></a> verifies that a user’s own microposts appear in the feed, while the micropost from an unfollowed user doesn’t appear.<span class="intersentencespace"></span> Now that we know how to follow users, we can add a third type of test, this time checking that the microposts of a followed user appear in the feed, as shown in <a href="http://www.railstutorial.org/book/following_users#code-full_feed_specs" class="hyperref">Listing&nbsp;<span class="ref">11.41</span></a>.</p>
<div class="codelisting" id="_code-full_feed_specs" data-tralics-id="uid946" data-number="11.41"><div class="heading"><span class="number">Listing 11.41:</span> 

<span class="description">The final tests for the status feed.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"micropost associations"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="vi">@user</span><span class="p">,</span> <span class="n">created_at</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="vi">@user</span><span class="p">,</span> <span class="n">created_at</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"status"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:unfollowed_post</span><span class="p">)</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
      <span class="k">end</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:followed_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">before</span> <span class="k">do</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">followed_user</span><span class="p">)</span>
        <span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">followed_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">newer_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">older_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="n">unfollowed_post</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">followed_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
          <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">micropost</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The feed itself simply defers the hard work to <code>Micropost.from_users_followed_by</code>, as shown in <a href="http://www.railstutorial.org/book/following_users#code-user_feed" class="hyperref">Listing&nbsp;<span class="ref">11.42</span></a>.</p>
<div class="codelisting" id="_code-user_feed" data-tralics-id="uid947" data-number="11.42"><div class="heading"><span class="number">Listing 11.42:</span> 

<span class="description">Adding the completed feed to the User model.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div></div>
<div id="_sec-a_first_feed_implementation" data-tralics-id="uid948" class="subsection" data-number="11.3.2"><h3><a href="http://www.railstutorial.org/book/following_users#sec-a_first_feed_implementation" class="heading hyperref"><span class="number">11.3.2 </span>A first feed implementation</a></h3>
<p>Now it’s time to implement <code>Micropost.from_users_followed_by</code>, which for simplicity we’ll just refer to as “the feed”.<span class="intersentencespace"></span> Since the final result is rather intricate, we’ll build up to the final feed implementation by introducing one piece at a time.</p>
<p>The first step is to think of the kind of query we’ll need.<span class="intersentencespace"></span> What we want to do is select from the <code>microposts</code> table all the microposts with ids corresponding to the users being followed by a given user (or the user itself).<span class="intersentencespace"></span> We might write this schematically as follows:</p>
<div class="code"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">microposts</span>
<span class="k">WHERE</span> <span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">list</span> <span class="k">of</span> <span class="n">ids</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">OR</span> <span class="n">user_id</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">user</span> <span class="n">id</span><span class="o">&gt;</span>
</pre></div></div>
<p>In writing this code, we’ve guessed that SQL supports an <code>IN</code> keyword that allows us to test for set inclusion.<span class="intersentencespace"></span> (Happily, it does.)</p>
<p>Recall from the proto-feed in <a href="http://www.railstutorial.org/book/user_microposts#sec-a_proto_feed" class="hyperref">Section&nbsp;<span class="ref">10.3.3</span></a> that Active Record uses the <code>where</code> method to accomplish the kind of select shown above, as illustrated in <a href="http://www.railstutorial.org/book/user_microposts#code-proto_status_feed" class="hyperref">Listing&nbsp;<span class="ref">10.36</span></a>.<span class="intersentencespace"></span> There, our select was very simple; we just picked out all the microposts with user id corresponding to the current user:</p>
<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id = ?"</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div></div>
<p>Here, we expect it to be more complicated, something like</p>
<div class="code"><div class="highlight"><pre><span class="n">where</span><span class="p">(</span><span class="s2">"user_id in (?) OR user_id = ?"</span><span class="p">,</span> <span class="n">following_ids</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p>(Here we’ve used the Rails convention of <code>user</code> instead of <code>user.id</code> in the condition; Rails automatically uses the&nbsp;<code>id</code>.<span class="intersentencespace"></span> We’ve also omitted the leading <code>Micropost.</code> since we expect this method to live in the Micropost model itself.)</p>
<p>We see from these conditions that we’ll need an array of ids corresponding to the users being followed.<span class="intersentencespace"></span> One way to do this is to use Ruby’s <code>map</code> method, available on any “enumerable” object, i.e., any object (such as an Array or a Hash) that consists of a collection of elements.<sup id="_cha-11_footnote-ref-10" class="footnote intersentence"><a href="http://www.railstutorial.org/book/following_users#cha-11_footnote-10">10</a></sup><span class="intersentencespace"></span> We saw an example of this method in <a href="http://www.railstutorial.org/book/rails_flavored_ruby#sec-blocks" class="hyperref">Section&nbsp;<span class="ref">4.3.2</span></a>; it works like this:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span>
<span class="go">=&gt; ["1", "2", "3", "4"]</span>
</pre></div></div>
<p>Situations like the one illustrated above, where the same method (e.g., <code>to_s</code>) gets called on each element, are common enough that there’s a shorthand notation using an <em>ampersand</em>&nbsp;<code>&amp;</code> and a symbol corresponding to the method:<sup id="_cha-11_footnote-ref-11" class="footnote"><a href="http://www.railstutorial.org/book/following_users#cha-11_footnote-11">11</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span>
<span class="go">=&gt; ["1", "2", "3", "4"]</span>
</pre></div></div>
<p>Using the <code>join</code> method(<a href="http://www.railstutorial.org/book/rails_flavored_ruby#sec-arrays_and_ranges" class="hyperref">Section&nbsp;<span class="ref">4.3.1</span></a>), we can create a string composed of the ids by joining them on comma-space :</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span>
<span class="go">=&gt; "1, 2, 3, 4"</span>
</pre></div></div>
<p>We can use the above method to construct the necessary array of followed user ids by calling&nbsp;<code>id</code> on each element in <code>user.followed_users</code>.<span class="intersentencespace"></span> For example, for the first user in the database this array appears as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">followed_users</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span>
<span class="go">=&gt; [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,</span>
<span class="go">24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,</span>
<span class="go">43, 44, 45, 46, 47, 48, 49, 50, 51]</span>
</pre></div></div>
<p>In fact, because this sort of construction is so useful, Active Record provides it by default:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">followed_user_ids</span>
<span class="go">=&gt; [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,</span>
<span class="go">24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,</span>
<span class="go">43, 44, 45, 46, 47, 48, 49, 50, 51]</span>
</pre></div></div>
<p>Here the <code>followed_user_ids</code> method is synthesized by Active Record based on the <code>has_many :followed_users</code> association (<a href="http://www.railstutorial.org/book/following_users#code-has_many_following_through_relationships" class="hyperref">Listing&nbsp;<span class="ref">11.10</span></a>); the result is that we need only append <code>_ids</code> to the association name to get the ids corresponding to the <code>user.followed_users</code> collection.<span class="intersentencespace"></span> A string of followed user ids then appears as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">followed_user_ids</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span>
<span class="go">=&gt; "4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,</span>
<span class="go">24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,</span>
<span class="go">43, 44, 45, 46, 47, 48, 49, 50, 51"</span>
</pre></div></div>
<p>When inserting into an SQL string, though, you don’t need to do this; the <code>?</code> interpolation takes care of it for you (and in fact eliminates some database-dependent incompatibilities).<span class="intersentencespace"></span> This means we can use</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
</pre></div></div>
<p>by itself.</p>
<p>At this point, you might guess that code like</p>
<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p>will involve a class method in the <code>Micropost</code> class (a construction mentioned briefly in <a href="http://www.railstutorial.org/book/rails_flavored_ruby#sec-constructors" class="hyperref">Section&nbsp;<span class="ref">4.4.1</span></a>).<span class="intersentencespace"></span> A proposed implementation along these lines appears in <a href="http://www.railstutorial.org/book/following_users#code-from_users_followed_by_first_cut" class="hyperref">Listing&nbsp;<span class="ref">11.43</span></a>.</p>
<div class="codelisting" id="_code-from_users_followed_by_first_cut" data-tralics-id="uid951" data-number="11.43"><div class="heading"><span class="number">Listing 11.43:</span> 

<span class="description">A first cut at the <code>from_users_followed_by</code> method.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/micropost.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">followed_user_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (?) OR user_id = ?"</span><span class="p">,</span> <span class="n">followed_user_ids</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Although the discussion leading up to <a href="http://www.railstutorial.org/book/following_users#code-from_users_followed_by_first_cut" class="hyperref">Listing&nbsp;<span class="ref">11.43</span></a> was couched in hypothetical terms, it actually works!<span class="intersentencespace"></span> You can verify this yourself by running the test suite, which should pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<p>In some applications, this initial implementation might be good enough for most practical purposes.<span class="intersentencespace"></span> But it’s not the final implementation; see if you can make a guess about why not before moving on to the next section.<span class="intersentencespace"></span> (<em>Hint:</em> What if a user is following 5000 other users?)</p>
</div>
<div id="_sec-scopes_subselects_and_a_lambda" data-tralics-id="uid952" class="subsection" data-number="11.3.3"><h3><a href="http://www.railstutorial.org/book/following_users#sec-scopes_subselects_and_a_lambda" class="heading hyperref"><span class="number">11.3.3 </span>Subselects</a></h3>
<p>As hinted at in the last section, the feed implementation in <a href="http://www.railstutorial.org/book/following_users#sec-a_first_feed_implementation" class="hyperref">Section&nbsp;<span class="ref">11.3.2</span></a> doesn’t scale well when the number of microposts in the feed is large, as would likely happen if a user were following, say, 5000 other users.<span class="intersentencespace"></span> In this section, we’ll reimplement the status feed in a way that scales better with the number of followed users.</p>
<p>The problem with the code in <a href="http://www.railstutorial.org/book/following_users#sec-a_first_feed_implementation" class="hyperref">Section&nbsp;<span class="ref">11.3.2</span></a> is that</p>
<div class="code"><div class="highlight"><pre><span class="n">followed_user_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
</pre></div></div>
<p>pulls <em>all</em> the followed users’ ids into memory, and creates an array the full length of the followed users array.<span class="intersentencespace"></span> Since the condition in <a href="http://www.railstutorial.org/book/following_users#code-from_users_followed_by_first_cut" class="hyperref">Listing&nbsp;<span class="ref">11.43</span></a> actually just checks inclusion in a set, there must be a more efficient way to do this, and indeed SQL is optimized for just such set operations.The solution involves pushing the finding of followed user ids into the database using a <em>subselect</em>.</p>
<p>We’ll start by refactoring the feed with the slightly modified code in <a href="http://www.railstutorial.org/book/following_users#code-from_users_followed_by_second_cut" class="hyperref">Listing&nbsp;<span class="ref">11.44</span></a>.</p>
<div class="codelisting" id="_code-from_users_followed_by_second_cut" data-tralics-id="uid953" data-number="11.44"><div class="heading"><span class="number">Listing 11.44:</span> 

<span class="description">Improving <code>from_users_followed_by</code>.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/micropost.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Returns microposts from the users being followed by the given user.</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">followed_user_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (:followed_user_ids) OR user_id = :user_id"</span><span class="p">,</span>
          <span class="n">followed_user_ids</span><span class="p">:</span> <span class="n">followed_user_ids</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>As preparation for the next step, we have replaced</p>
<div class="code"><div class="highlight"><pre><span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (?) OR user_id = ?"</span><span class="p">,</span> <span class="n">followed_user_ids</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p>with the equivalent</p>
<div class="code"><div class="highlight"><pre><span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (:followed_user_ids) OR user_id = :user_id"</span><span class="p">,</span>
      <span class="n">followed_user_ids</span><span class="p">:</span> <span class="n">followed_user_ids</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p>The question mark syntax is fine, but when we want the <em>same</em> variable inserted in more than one place, the second syntax is more convenient.</p>
<p>The above discussion implies that we will be adding a <em>second</em> occurrence of <code>user_id</code> in the SQL query.<span class="intersentencespace"></span> In particular, we can replace the Ruby code</p>
<div class="code"><div class="highlight"><pre><span class="n">followed_user_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
</pre></div></div>
<p>with the SQL snippet</p>
<div class="code"><div class="highlight"><pre><span class="n">followed_user_ids</span> <span class="o">=</span> <span class="s2">"SELECT followed_id FROM relationships</span>
<span class="s2">                     WHERE follower_id = :user_id"</span>
</pre></div></div>
<p>This code contains an SQL subselect, and internally the entire select for user&nbsp;1 would look something like this:</p>
<div class="code"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">microposts</span>
<span class="k">WHERE</span> <span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">followed_id</span> <span class="k">FROM</span> <span class="n">relationships</span>
                  <span class="k">WHERE</span> <span class="n">follower_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">OR</span> <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div></div>
<p>This subselect arranges for all the set logic to be pushed into the database, which is more efficient.<sup id="_cha-11_footnote-ref-12" class="footnote"><a href="http://www.railstutorial.org/book/following_users#cha-11_footnote-12">12</a></sup></p>
<p>With this foundation, we are ready for an efficient feed implementation, as seen in <a href="http://www.railstutorial.org/book/following_users#code-from_users_followed_by_final" class="hyperref">Listing&nbsp;<span class="ref">11.45</span></a>.<span class="intersentencespace"></span> Note that, because it is now raw SQL, <code>followed_user_ids</code> is <em>interpolated</em>, not escaped.<span class="intersentencespace"></span> (It actually works either way, but logically it makes more sense to interpolate in this context.)</p>
<div class="codelisting" id="_code-from_users_followed_by_final" data-tralics-id="uid955" data-number="11.45"><div class="heading"><span class="number">Listing 11.45:</span> 

<span class="description">The final implementation of <code>from_users_followed_by</code>.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/micropost.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">default_scope</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">'created_at DESC'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">140</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>

  <span class="c1"># Returns microposts from the users being followed by the given user.</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">followed_user_ids</span> <span class="o">=</span> <span class="s2">"SELECT followed_id FROM relationships</span>
<span class="s2">                         WHERE follower_id = :user_id"</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (</span><span class="si">#{</span><span class="n">followed_user_ids</span><span class="si">}</span><span class="s2">) OR user_id = :user_id"</span><span class="p">,</span>
          <span class="n">user_id</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>This code has a formidable combination of Rails, Ruby, and SQL, but it does the job, and does it well.<span class="intersentencespace"></span> (Of course, even the subselect won’t scale forever.<span class="intersentencespace"></span> For bigger sites, you would probably need to generate the feed asynchronously using a background job, but such scaling subtleties are beyond the scope of this tutorial.)</p>
</div>
<div id="_sec-the_new_status_feed" data-tralics-id="uid956" class="subsection" data-number="11.3.4"><h3><a href="http://www.railstutorial.org/book/following_users#sec-the_new_status_feed" class="heading hyperref"><span class="number">11.3.4 </span>The new status feed</a></h3>
<p>With the code in <a href="http://www.railstutorial.org/book/following_users#code-from_users_followed_by_final" class="hyperref">Listing&nbsp;<span class="ref">11.45</span></a>, our status feed is complete.<span class="intersentencespace"></span> As a reminder, the code for the Home page appears in <a href="http://www.railstutorial.org/book/following_users#code-real_feed_instance_variable" class="hyperref">Listing&nbsp;<span class="ref">11.46</span></a>; this code creates a paginated feed of the relevant microposts for use in the view, as seen in <a href="http://www.railstutorial.org/book/following_users#fig-home_page_with_feed" class="hyperref">Figure&nbsp;<span class="ref">11.20</span></a>.<sup id="_cha-11_footnote-ref-13" class="footnote intersentence"><a href="http://www.railstutorial.org/book/following_users#cha-11_footnote-13">13</a></sup><span class="intersentencespace"></span> Note that the <code>paginate</code> method actually reaches all the way into the Micropost model method in <a href="http://www.railstutorial.org/book/following_users#code-from_users_followed_by_final" class="hyperref">Listing&nbsp;<span class="ref">11.45</span></a>, arranging to pull out only&nbsp;30 microposts at a time from the database.<span class="intersentencespace"></span> (You can verify this by examining the SQL statements in the development server log file.)</p>
<div class="codelisting" id="_code-real_feed_instance_variable" data-tralics-id="uid958" data-number="11.46"><div class="heading"><span class="number">Listing 11.46:</span> 

<span class="description">The <code>home</code> action with a paginated feed.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/static_pages_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="k">if</span> <span class="n">signed_in?</span>
      <span class="vi">@micropost</span>  <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="center figure" id="_fig-home_page_with_feed" data-tralics-id="uid959" data-number="11.20">
<div class="graphics image box"><img src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/home_page_with_feed_bootstrap.png" alt="images/figures/home_page_with_feed_bootstrap"></div><div class="caption"><span class="header">Figure 11.20: </span><span class="description">The Home page with a working status feed.
</span></div></div>
</div></div><div id="_sec-following_conclusion" data-tralics-id="cid69" class="section" data-number="11.4"><h2><a href="http://www.railstutorial.org/book/following_users#sec-following_conclusion" class="heading hyperref"><span class="number">11.4 </span>Conclusion</a></h2>
<p>With the addition of the status feed, we’ve finished the core sample application for the <em>Ruby on Rails Tutorial</em>.<span class="intersentencespace"></span> This application includes examples of all the major features of Rails, including models, views, controllers, templates, partials, filters, validations, callbacks, <code>has_many</code>/<code>belongs_to</code> and <code>has_many through</code> associations, security, testing, and deployment.<span class="intersentencespace"></span> Despite this impressive list, there is still much to learn about Rails.<span class="intersentencespace"></span> As a first step in this process, this section contains some suggested extensions to the core application, as well as suggestions for further learning.</p>
<p>Before moving on to tackle any of the application extensions, it’s a good idea to merge in your changes:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Add user following"</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge following-users
</pre></div></div>
<p>As usual, you can also push the code and deploy the application if you want:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
<span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku pg:reset DATABASE
<span class="gp">$</span> heroku run rake db:migrate
<span class="gp">$</span> heroku run rake db:populate
</pre></div></div>
<div id="_sec-extensions_to_the_sample_application" data-tralics-id="uid960" class="subsection" data-number="11.4.1"><h3><a href="http://www.railstutorial.org/book/following_users#sec-extensions_to_the_sample_application" class="heading hyperref"><span class="number">11.4.1 </span>Extensions to the sample application</a></h3>
<p>The proposed extensions in this section are mostly inspired either by general features common to web applications, such as password reminders and email confirmation, or features specific to our type of sample application, such as search, replies, and messaging.<span class="intersentencespace"></span> Implementing one or more of these application extensions will help you make the transition from following a tutorial to writing original applications of your own.</p>
<p>Don’t be surprised if it’s tough going at first; the blank slate of a new feature can be quite intimidating.<span class="intersentencespace"></span> To help get you started, I can give two pieces of general advice.<span class="intersentencespace"></span> First, before adding any feature to a Rails application, take a look at the <a href="http://railscasts.com/episodes/archive">RailsCasts archive</a> to see if Ryan Bates has already covered the subject.<sup id="_cha-11_footnote-ref-14" class="footnote intersentence"><a href="http://www.railstutorial.org/book/following_users#cha-11_footnote-14">14</a></sup><span class="intersentencespace"></span> If he has, watching the relevant RailsCast first will often save you a ton of time.<span class="intersentencespace"></span> Second, always do extensive Google searches on your proposed feature to find relevant blog posts and tutorials.<span class="intersentencespace"></span> Web application development is hard, and it helps to learn from the experience (and mistakes) of others.</p>
<p>Many of the following features are quite challenging, and I have given some hints about the tools you might need to implement them.<span class="intersentencespace"></span> Even with hints, they are <em>much</em> more difficult than the book’s end-of-chapter exercises, so don’t be discouraged if you can’t solve them without considerable effort.<span class="intersentencespace"></span> Due to time constraints, I am not available for one-on-one assistance, but if there is sufficient interest I might release standalone article/screencast bundles on some of these extensions in the future; go to the main Rails Tutorial website at <a href="http://railstutorial.org/">http://railstutorial.org/</a> and subscribe to the news feed to get the latest updates.</p>
<div id="_sec-replies" data-tralics-id="uid962" class="subsubsection" data-number="11.4.1.1"><h4><a href="http://www.railstutorial.org/book/following_users#sec-replies" class="heading">Replies</a></h4>
<p>Twitter allows users to make “@replies”, which are microposts whose first characters are the user’s login preceded by the <span class="tt">@</span>&nbsp;sign.<span class="intersentencespace"></span> These posts only appear in the feed of the user in question or users following that user.<span class="intersentencespace"></span> Implement a simplified version of this, restricting @replies to appear only in the feeds of the recipient and the sender.<span class="intersentencespace"></span> This might involve adding an <code>in_reply_to</code> column in the <code>microposts</code> table and an extra <code>including_replies</code> scope to the Micropost model.</p>
<p>Since our application lacks unique user logins, you will also have to decide on a way to represent users.<span class="intersentencespace"></span> One option is to use a combination of the id and the name, such as <code>@1-michael-hartl</code>.<span class="intersentencespace"></span> Another is to <em>add</em> a unique username to the signup process and then use it in @replies.</p>
</div>
<div id="_sec-messaging" data-tralics-id="uid963" class="subsubsection" data-number="11.4.1.2"><h4><a href="http://www.railstutorial.org/book/following_users#sec-messaging" class="heading">Messaging</a></h4>
<p>Twitter supports direct (private) messaging by prefixing a micropost with the letter&nbsp;“d”.<span class="intersentencespace"></span> Implement this feature for the sample application.<span class="intersentencespace"></span> The solution will probably involve a Message model and a regular expression match on new microposts.</p>
</div>
<div id="_sec-follower_notifications" data-tralics-id="uid964" class="subsubsection" data-number="11.4.1.3"><h4><a href="http://www.railstutorial.org/book/following_users#sec-follower_notifications" class="heading">Follower notifications</a></h4>
<p>Implement a feature to send each user an email notification when they gain a new follower.<span class="intersentencespace"></span> Then make the notification optional, so that users can opt out if desired.<span class="intersentencespace"></span> Among other things, adding this feature requires learning how to send mail with Rails.<span class="intersentencespace"></span> To get started, I suggest viewing the <a href="http://railscasts.com/episodes/206-action-mailer-in-rails-3">RailsCast on Action Mailer in Rails&nbsp;3</a>.</p>
</div>
<div id="_sec-password_reminders" data-tralics-id="uid965" class="subsubsection" data-number="11.4.1.4"><h4><a href="http://www.railstutorial.org/book/following_users#sec-password_reminders" class="heading">Password reminders</a></h4>
<p>Currently, if our application’s users forget their passwords, they have no way to retrieve them.<span class="intersentencespace"></span> Because of the one-way secure password hashing in <a href="http://www.railstutorial.org/book/modeling_users#cha-modeling_users" class="hyperref">Chapter&nbsp;<span class="ref">6</span></a>, our application can’t email the user’s password, but it can send a link to a reset form.<span class="intersentencespace"></span> Follow the steps in the <a href="http://railscasts.com/episodes/274-remember-me-reset-password">RailsCast on Remember Me &amp; Reset Password</a> to fix this omission.</p>
</div>
<div id="_sec-signup_confirmation" data-tralics-id="uid966" class="subsubsection" data-number="11.4.1.5"><h4><a href="http://www.railstutorial.org/book/following_users#sec-signup_confirmation" class="heading">Signup confirmation</a></h4>
<p>Apart from an email regular expression, the sample application currently has no way to verify the validity of a user’s email address.<span class="intersentencespace"></span> Add an email address verification step to confirm a user’s signup.<span class="intersentencespace"></span> The new feature should create users in an inactive state, email the user an activation URL, and then change the user to an active state when the URL gets hit.<span class="intersentencespace"></span> You might want to read up on <a href="http://www.google.com/search?q=state+machines+in+rails">state machines in Rails</a> to help you with the inactive/active transition.</p>
</div>
<div id="_sec-rss_feed" data-tralics-id="uid967" class="subsubsection" data-number="11.4.1.6"><h4><a href="http://www.railstutorial.org/book/following_users#sec-rss_feed" class="heading">RSS feed</a></h4>
<p>For each user, implement an RSS feed for their microposts.<span class="intersentencespace"></span> Then implement an RSS feed for their status feed, optionally restricting access to that feed using an authentication scheme.<span class="intersentencespace"></span> The <a href="http://railscasts.com/episodes/87-generating-rss-feeds">RailsCast on generating RSS feeds</a> will help get you started.</p>
</div>
<div id="_sec-rest_api" data-tralics-id="uid968" class="subsubsection" data-number="11.4.1.7"><h4><a href="http://www.railstutorial.org/book/following_users#sec-rest_api" class="heading">REST API</a></h4>
<p>Many websites expose an Application Programmer Interface (API) so that third-party applications can get, post, put, and delete the application’s resources.<span class="intersentencespace"></span> Implement such a REST API for the sample application.<span class="intersentencespace"></span> The solution will involve adding <code>respond_to</code> blocks (<a href="http://www.railstutorial.org/book/following_users#sec-a_working_follow_button_with_ajax" class="hyperref">Section&nbsp;<span class="ref">11.2.5</span></a>) to many of the application’s controller actions; these should respond to requests for XML. Be careful about security; the API should only be accessible to authorized users.</p>
</div>
<div id="_sec-search" data-tralics-id="uid969" class="subsubsection" data-number="11.4.1.8"><h4><a href="http://www.railstutorial.org/book/following_users#sec-search" class="heading">Search</a></h4>
<p>Currently, there is no way for users to find each other, apart from paging through the user index or viewing the feeds of other users.<span class="intersentencespace"></span> Implement a search feature to remedy this.<span class="intersentencespace"></span> Then add another search feature for microposts.<span class="intersentencespace"></span> The <a href="http://railscasts.com/episodes/37-simple-search-form">RailsCast on simple search forms</a> will help get you started.<span class="intersentencespace"></span> If you deploy using a shared host or a dedicated server, I suggest using <a href="http://freelancing-god.github.com/ts/en/">Thinking Sphinx</a> (following the <a href="http://railscasts.com/episodes/120-thinking-sphinx">RailsCast on Thinking Sphinx</a>).<span class="intersentencespace"></span> If you deploy on Heroku, you should follow the <a href="http://devcenter.heroku.com/articles/full-text-search">Heroku full text search</a> instructions.</p>
</div></div>
<div id="_sec-guide_to_further_resources" data-tralics-id="uid970" class="subsection" data-number="11.4.2"><h3><a href="http://www.railstutorial.org/book/following_users#sec-guide_to_further_resources" class="heading hyperref"><span class="number">11.4.2 </span>Guide to further resources</a></h3>
<p>There are a wealth of Rails resources in stores and on the web—indeed, the supply is so rich that it can be overwhelming.<span class="intersentencespace"></span> The good news is that, having gotten this far, you’re ready for almost anything else out there.<span class="intersentencespace"></span> Here are some suggestions for further learning:</p>
<ul><li><a href="http://railstutorial.org/screencasts">The <em>Ruby on Rails Tutorial</em> screencasts</a>: I have prepared a full-length screencast course based on this book.<span class="intersentencespace"></span> In addition to covering all the material in the book, the screencasts are filled with tips, tricks, and the kind of see-how-it’s-done demos that are hard to capture in print.<span class="intersentencespace"></span> They are available for purchase through the <a href="http://railstutorial.org/">Ruby on Rails Tutorial website</a>.
</li>
<li><a href="http://railscasts.com/">RailsCasts</a>: It’s hard to overemphasize what a great resource RailsCasts is.<span class="intersentencespace"></span> I suggest starting by visiting the <a href="http://railscasts.com/episodes/archive">RailsCasts episode archive</a> and clicking on subjects that catch your eye.
</li>
<li><a href="http://www.gotealeaf.com/railstutorial">Tealeaf Academy</a>: Lots of in-person developer bootcamps have sprung up in recent years, and I recommend looking for one in your area, but <a href="http://www.gotealeaf.com/railstutorial">Tealeaf Academy</a> is available online and so can be taken from anywhere.<span class="intersentencespace"></span> Tealeaf is an especially good choice if you want instructor feedback within the context of a structured curriculum.
</li>
<li>Ruby and Rails books: I recommend <a href="http://www.amazon.com/gp/product/1430223634"><em>Beginning Ruby</em></a> by Peter Cooper, <a href="http://www.amazon.com/gp/product/1933988657"><em>The Well-Grounded Rubyist</em></a> by David&nbsp;A. Black, <a href="http://www.amazon.com/Eloquent-Ruby-Addison-Wesley-Professional-Series/dp/0321584104/"><em>Eloquent Ruby</em></a> by Russ Olsen, and <a href="http://www.amazon.com/gp/product/0672328844"><em>The Ruby Way</em></a> by Hal Fulton for further Ruby learning, and <a href="http://www.amazon.com/gp/product/0321601661"><em>The Rails&nbsp;3 Way</em></a> by Obie Fernandez and <em>Rails&nbsp;3 in Action</em> (wait for the second edition) by Ryan Bigg and Yehuda Katz for more about Rails.
</li>
<li><a href="http://peepcode.com/">PeepCode</a> and <a href="http://mbsy.co/6VQ8l">Code School</a>: The screencasts at PeepCode and interactive courses at Code School are consistently high-quality, and I warmly recommend them.
</li></ul></div></div><div id="_sec-following_exercises" data-tralics-id="cid70" class="section" data-number="11.5"><h2><a href="http://www.railstutorial.org/book/following_users#sec-following_exercises" class="heading hyperref"><span class="number">11.5 </span>Exercises</a></h2>
<ol><li>Add tests for destroying relationships associated with a given user (i.e., as implemented by <code>dependent :destroy</code> in <a href="http://www.railstutorial.org/book/following_users#code-user_relationships_association" class="hyperref">Listing&nbsp;<span class="ref">11.4</span></a> and <a href="http://www.railstutorial.org/book/following_users#code-user_reverse_relationships" class="hyperref">Listing&nbsp;<span class="ref">11.16</span></a>).<span class="intersentencespace"></span> <em>Hint</em>: Follow the example in <a href="http://www.railstutorial.org/book/user_microposts#code-micropost_dependency_test" class="hyperref">Listing&nbsp;<span class="ref">10.12</span></a>.<span class="intersentencespace"></span>
</li>
<li>The <code>respond_to</code> method seen in <a href="http://www.railstutorial.org/book/following_users#code-relationships_controller_ajax" class="hyperref">Listing&nbsp;<span class="ref">11.38</span></a> can actually be hoisted out of the actions into the Relationships controller itself, and the <code>respond_to</code> blocks can be replaced with a Rails method called <code>respond_with</code>.<span class="intersentencespace"></span> Prove that the resulting code, shown in <a href="http://www.railstutorial.org/book/following_users#code-compact_respond_to" class="hyperref">Listing&nbsp;<span class="ref">11.47</span></a>, is correct by verifying that the test suite still passes.<span class="intersentencespace"></span> (For details on this method, do a Google search on “rails respond_with”.)
</li>
<li>Refactor <a href="http://www.railstutorial.org/book/following_users#code-show_follow_view" class="hyperref">Listing&nbsp;<span class="ref">11.31</span></a> by adding partials for the code common to the following/followers pages, the Home page, and the user show page.<span class="intersentencespace"></span>
</li>
<li>Following the model in <a href="http://www.railstutorial.org/book/following_users#code-stats_view_test" class="hyperref">Listing&nbsp;<span class="ref">11.19</span></a>, write tests for the stats on the profile page.<span class="intersentencespace"></span>
</li></ol><div class="codelisting" id="_code-compact_respond_to" data-tralics-id="uid980" data-number="11.47"><div class="heading"><span class="number">Listing 11.47:</span> 

<span class="description">A compact refactoring of <a href="http://www.railstutorial.org/book/following_users#code-relationships_controller_ajax" class="hyperref">Listing&nbsp;<span class="ref">11.38</span></a>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span>

  <span class="n">respond_to</span> <span class="ss">:html</span><span class="p">,</span> <span class="ss">:js</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:relationship</span><span class="o">][</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_with</span> <span class="vi">@user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_with</span> <span class="vi">@user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div></div><div id="cha-11_footnotes">
  <ol class="footnotes"><li id="_cha-11_footnote-1">The photographs in the mockup tour are from <a href="http://www.flickr.com/photos/john_lustig/2518452221/">http://www.flickr.com/photos/john_lustig/2518452221/</a> and http://www.flickr.com/photos/30775272@N05/2884963755/ (link expired).&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/following_users#cha-11_footnote-ref-1">↑</a></li>
    <li id="_cha-11_footnote-2">The first edition of this book used the <code>user.following</code> terminology, which even I found confusing at times.<span class="intersentencespace"></span> Thanks to reader Cosmo Lee for convincing me to change the terminology and for offering suggestions on how to make it clearer.<span class="intersentencespace"></span> (I didn’t follow his exact advice, though, so if it’s still confusing he bears none of the blame.)&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/following_users#cha-11_footnote-ref-2">↑</a></li>
    <li id="_cha-11_footnote-3">For simplicity, <a href="http://www.railstutorial.org/book/following_users#fig-naive_user_has_many_following" class="hyperref">Figure&nbsp;<span class="ref">11.6</span></a> suppresses the <code>followed_users</code> table’s&nbsp;<code>id</code> column.&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/following_users#cha-11_footnote-ref-3">↑</a></li>
    <li id="_cha-11_footnote-4">See the discussion on <a href="http://stackoverflow.com/questions/5359558/when-to-use-rspec-let">when to use let at Stack Overflow</a> for more information.&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/following_users#cha-11_footnote-ref-4">↑</a></li>
    <li id="_cha-11_footnote-5">Technically, Rails uses the <code>underscore</code> method to convert the class name to an id.<span class="intersentencespace"></span> For example, <code>"FooBar".underscore</code> is <code>"foo_bar"</code>, so the foreign key for a <code>FooBar</code> object would be <code>foo_bar_id</code>.<span class="intersentencespace"></span> (Incidentally, the inverse of <code>underscore</code> is <code>camelize</code>, which converts <code>"camel_case"</code> to <code>"CamelCase"</code>.)&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/following_users#cha-11_footnote-ref-5">↑</a></li>
    <li id="_cha-11_footnote-6">If you’ve noticed that <code>followed_id</code> also identifies a user, and are concerned about the asymmetric treatment of followed and follower, you’re ahead of the game.<span class="intersentencespace"></span> We’ll deal with this issue in <a href="http://www.railstutorial.org/book/following_users#sec-followers" class="hyperref">Section&nbsp;<span class="ref">11.1.5</span></a>.&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/following_users#cha-11_footnote-ref-6">↑</a></li>
    <li id="_cha-11_footnote-7">Once you have a lot of experience modeling a particular domain, you can often guess such utility methods in advance, and even when you can’t you’ll often find yourself writing them to make the tests cleaner.<span class="intersentencespace"></span> In this case, though, it’s OK if you wouldn’t have guessed them.<span class="intersentencespace"></span> Software development is usually an iterative process—you write code until it starts getting ugly, and then you refactor it—but for brevity the tutorial presentation is streamlined a bit.&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/following_users#cha-11_footnote-ref-7">↑</a></li>
    <li id="_cha-11_footnote-8">Because it is nominally an acronym for <em>asynchronous JavaScript and XML</em>, Ajax is sometimes misspelled “AJAX”, even though the <a href="http://www.adaptivepath.com/ideas/essays/archives/000385.php">original Ajax article</a> spells it as “Ajax” throughout.&nbsp;<a class="arrow" href="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io.html">↑</a></li>
    <li id="_cha-11_footnote-9">This only works if JavaScript is enabled in the browser, but it degrades gracefully, working exactly as in <a href="http://www.railstutorial.org/book/following_users#sec-a_working_follow_button_the_standard_way" class="hyperref">Section&nbsp;<span class="ref">11.2.4</span></a> if JavaScript is disabled.&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/following_users#cha-11_footnote-ref-9">↑</a></li>
    <li id="_cha-11_footnote-10">The main requirement is that enumerable objects must implement an <code>each</code> method to iterate through the collection.&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/following_users#cha-11_footnote-ref-10">↑</a></li>
    <li id="_cha-11_footnote-11">This notation actually started as an extension Rails made to the core Ruby language; it was so useful that it has now been incorporated into Ruby itself.<span class="intersentencespace"></span> How cool is that?&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/following_users#cha-11_footnote-ref-11">↑</a></li>
    <li id="_cha-11_footnote-12">For a more advanced way to create the necessary subselect, see the blog post <a href="http://pivotallabs.com/users/jsusser/blog/articles/567-hacking-a-subselect-in-activerecord">“Hacking a subselect in ActiveRecord”.</a>&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/following_users#cha-11_footnote-ref-12">↑</a></li>
    <li id="_cha-11_footnote-13">In order to make a prettier feed for <a href="http://www.railstutorial.org/book/following_users#fig-home_page_with_feed" class="hyperref">Figure&nbsp;<span class="ref">11.20</span></a>, I’ve added a few extra microposts by hand using the Rails console.&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/following_users#cha-11_footnote-ref-13">↑</a></li>
    <li id="_cha-11_footnote-14">Note that RailsCasts usually omit the tests, which is probably necessary to keep the episodes nice and short, but you could get the wrong idea about the importance of testing.<span class="intersentencespace"></span> Once you’ve watched the relevant RailsCast to get a basic idea of how to proceed, I suggest writing the new feature using test-driven development.<span class="intersentencespace"></span> (In this context, I recommend taking a look at <a href="http://railscasts.com/episodes/275-how-i-test">the RailsCast on “How I test”</a>.<span class="intersentencespace"></span> You’ll see that Ryan Bates himself often uses TDD for real-life development, and in fact his testing style is similar to the style used in this tutorial.)&nbsp;<a class="arrow" href="http://www.railstutorial.org/book/following_users#cha-11_footnote-ref-14">↑</a></li>
  </ol></div></div></div>
<div id="bookBottomMenu">
<div class="bookMenuArows">
<a href="javascript://" class="leftArrow">◄</a>
<a href="javascript://" class="upArrow">▲</a>
<a href="javascript://" class="rightArrow">►</a>
</div>
</div>
</div>
<div id="bookContentNotAvailable">
<img alt="Empty_content" src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/empty_content-ccbfa2e7e03ec571f0360d9bdd87eff3.png">
Sorry, content not available
</div>
</div>
<div class="emailPitch" id="bookEmailModal">
<a href="javascript://" class="emailSignupClose" onclick="closeEmailPops()">x</a>
<strong>STAY UP TO DATE!</strong>
<p>Joining the email list for this book will allow the author to contact you to let you know about special offers and when updates for the book are available.</p>
<div class="j_followBookForm"><form accept-charset="UTF-8" action="http://www.softcover.io/follow/28fdb94f/ruby_on_rails_tutorial" method="get"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="✓"></div>
<input name="email" placeholder="YOUR EMAIL ADDRESS" type="text">
<input class="greyButton optClick_follow" type="submit" value="Follow Book">
</form>

</div>
</div>
<script>
  // setup book nav
  Book.init({
    title: "Ruby on Rails Tutorial",
    path: "/book",
    slug: "ruby_on_rails_tutorial",
    s3_path_prefix: "636/ruby_on_rails_tutorial",
    chapters: [{"title":"Frontmatter\n","number":0,"slug":"frontmatter","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/frontmatter_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=rqzWN0dafAmgcwv9PLq78UD9ujo%3D&Expires=1406551648"},{"title":"Chapter 1: From zero to deploy\n","number":1,"slug":"beginning","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/beginning_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=mQagf8UFMkxuhcf0N8CiPWqBK%2BU%3D&Expires=1406551648"},{"title":"Chapter 2: A demo app\n","number":2,"slug":"demo_app","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/demo_app_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=5NizM%2BCmFXg8PnTDH48NXj3sFtE%3D&Expires=1406551648"},{"title":"Chapter 3: Mostly static pages\n","number":3,"slug":"static_pages","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/static_pages_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=OgYHUhHCC9o2NhFRQNMIjeK3Q78%3D&Expires=1406551648"},{"title":"Chapter 4: Rails-flavored Ruby\n","number":4,"slug":"rails_flavored_ruby","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/rails_flavored_ruby_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=KMmuz%2BvsIb%2BcUHi%2B0U75wPbOFMk%3D&Expires=1406551648"},{"title":"Chapter 5: Filling in the layout\n","number":5,"slug":"filling_in_the_layout","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/filling_in_the_layout_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=4qzguAW0jQO6CeeVdQJvATk%2BGvM%3D&Expires=1406551648"},{"title":"Chapter 6: Modeling users\n","number":6,"slug":"modeling_users","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/modeling_users_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=viK%2BR3fT0LOlDT5uPwVxJAjtRg0%3D&Expires=1406551648"},{"title":"Chapter 7: Sign up\n","number":7,"slug":"sign_up","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/sign_up_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=p8%2B%2BHJ8vVWtu3KvupzSM2hGBJWU%3D&Expires=1406551648"},{"title":"Chapter 8: Sign in, sign out\n","number":8,"slug":"sign_in_out","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/sign_in_out_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=l1m6we0l01nUmqf/3UOz1yGpvoI%3D&Expires=1406551648"},{"title":"Chapter 9: Updating, showing, and deleting users\n","number":9,"slug":"updating_and_deleting_users","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/updating_and_deleting_users_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=AdcH/yZPCtpRBfF73epBFcMifQc%3D&Expires=1406551648"},{"title":"Chapter 10: User microposts\n","number":10,"slug":"user_microposts","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/user_microposts_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=pkDQ0zKoUpBE5H0MpU8wJscYzdY%3D&Expires=1406551648"},{"title":"Chapter 11: Following users\n","number":11,"slug":"following_users","s3_url":"https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/html/following_users_fragment.html?AWSAccessKeyId=AKIAJMNNDDBSYVXVHGAA&Signature=aHnBBsbHKuUM7RSqNIFaaXYvSAM%3D&Expires=1406551648"}],
    full_page: false
  });
</script>

</div>
</div>
<div class="footer clearfix">
<div class="wrapper" id="hide_chromeFooter">
<em>powered by</em>
<a href="http://www.softcover.io/" class="logo"><img alt="Logo_foot" src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/logo_foot-39da4a3be1566a91864f2712656b404e.png">
</a></div>
</div>

<script type="text/javascript">
setTimeout(function(){var a=document.createElement("script");
var b=document.getElementsByTagName("script")[0];
a.src=document.location.protocol+"//dnn506yrbagrg.cloudfront.net/pages/scripts/0023/6713.js?"+Math.floor(new Date().getTime()/3600000);
a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
</script>

<script type="text/javascript">
  var _sf_async_config = { uid: 9895, domain: 'softcover.io', useCanonical: true };
  (function() {
    function loadChartbeat() {
      window._sf_endpt = (new Date()).getTime();
      var e = document.createElement('script');
      e.setAttribute('language', 'javascript');
      e.setAttribute('type', 'text/javascript');
      e.setAttribute('src','//static.chartbeat.com/js/chartbeat.js');
      document.body.appendChild(e);
    };
    var oldonload = window.onload;
    window.onload = (typeof window.onload != 'function') ?
      loadChartbeat : function() { oldonload(); loadChartbeat(); };
  })();
</script>



<script src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/nr-411.min.js"></script><script language="javascript" type="text/javascript" src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/chartbeat.js"></script><script type="text/javascript" src="./Chapter 11  Following users   Ruby on Rails Tutorial   Softcover.io_files/1310fd97f1"></script><div id="MathJax_Font_Test" style="position: absolute; visibility: hidden; top: 0px; left: 0px; width: auto; padding: 0px; border: 0px; margin: 0px; white-space: nowrap; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; font-size: 40px; font-weight: normal; font-style: normal; font-family: MathJax_Main, sans-serif;"></div><div id="MathJax_Font_Test" style="position: absolute; visibility: hidden; top: 0px; left: 0px; width: auto; padding: 0px; border: 0px; margin: 0px; white-space: nowrap; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; font-size: 40px; font-weight: normal; font-style: normal; font-family: MathJax_Size4, sans-serif;"></div><div id="MathJax_Font_Test" style="position: absolute; visibility: hidden; top: 0px; left: 0px; width: auto; padding: 0px; border: 0px; margin: 0px; white-space: nowrap; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; font-size: 40px; font-weight: normal; font-style: normal; font-family: MathJax_Size4, sans-serif;"></div></body></html>